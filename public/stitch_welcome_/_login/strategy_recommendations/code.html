<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Space+Grotesk:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>CourseCraft AI - Strategy Recommendations</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
    :root {
      --primary-color: #3713ec;
      --red-glow: #ff4d4d;
      --blue-glow: #4d94ff;
      --white-glow: #ffffff;
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --ai-purple: #8b5cf6;
      --ai-teal: #14b8a6;
      --gradient-primary: linear-gradient(135deg, var(--ai-purple) 0%, var(--blue-glow) 100%);
    }
    
    /* Strategy Recommendation Styling */
    .strategy-panel {
        background: linear-gradient(135deg, #1a1823 0%, #2b2839 100%);
        border: 2px solid rgba(139, 92, 246, 0.4);
        border-radius: 24px;
        padding: 32px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
    }
    
    .strategy-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--ai-purple), var(--blue-glow), var(--ai-teal));
    }
    
    .strategy-card {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(20, 184, 166, 0.1) 100%);
        border: 2px solid rgba(139, 92, 246, 0.3);
        border-radius: 20px;
        padding: 24px;
        margin: 16px 0;
        transition: all 0.4s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .strategy-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(139, 92, 246, 0.3);
        border-color: var(--ai-purple);
    }
    
    .strategy-card.recommended {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.1) 100%);
        border-color: rgba(34, 197, 94, 0.4);
    }
    
    .strategy-badge {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .strategy-analyzing {
        background: linear-gradient(45deg, #f59e0b, #f97316);
        animation: pulse 2s infinite;
    }
    
    .strategy-ready {
        background: linear-gradient(45deg, #22c55e, #16a34a);
    }
    
    .strategy-complete {
        background: linear-gradient(45deg, #3b82f6, #2563eb);
    }
    
    @keyframes pulse {
        0%, 100% { 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            transform: scale(1);
        }
        50% { 
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
            transform: scale(1.02);
        }
    }
    
    .btn-strategy {
        background: linear-gradient(135deg, var(--ai-purple), var(--blue-glow));
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 16px 32px;
        font-weight: 700;
        font-size: 1.1rem;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-strategy:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(139, 92, 246, 0.5);
        border-color: rgba(255, 255, 255, 0.4);
    }
    
    .btn-strategy:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .strategy-spinner {
        width: 20px;
        height: 20px;
        border: 3px solid transparent;
        border-top: 3px solid currentColor;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        display: inline-block;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .strategy-type-badge {
        font-size: 0.75rem;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .type-microlearning { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .type-interactive { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .type-simulation { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .type-gamification { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
    .type-blended { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .type-social { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
</style>
</head>
<body>
<div class="relative flex size-full min-h-screen flex-col bg-[#121118] overflow-hidden" style='font-family: "Space Grotesk", "Noto Sans", sans-serif;'>

<!-- Enhanced Animated Background -->
<div class="absolute inset-0 opacity-25">
<div class="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-xl animate-pulse"></div>
<div class="absolute top-3/4 right-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-1000"></div>
<div class="absolute bottom-1/4 left-1/3 w-96 h-96 bg-teal-600 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-2000"></div>
</div>

<div class="relative z-10 layout-container flex h-full grow flex-col">

<!-- Strategy Header -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#2b2839]/70 px-10 py-6 backdrop-blur-md">
<div class="flex items-center gap-6 text-white">
<div class="size-10 text-[var(--ai-purple)]">
<svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M24 4C12.95 4 4 12.95 4 24s8.95 20 20 20 20-8.95 20-20S35.05 4 24 4zm-2 32l-8-8 2.83-2.83L22 30.34l9.17-9.17L34 24 22 36z"/>
</svg>
</div>
<div>
<h1 class="text-white text-2xl font-bold leading-tight tracking-[-0.015em]">CourseCraft AI</h1>
<p class="text-gray-400 text-sm">Strategy Recommendations • Dr. Elena Rodriguez</p>
</div>
<div id="strategy-status" class="strategy-badge strategy-analyzing">
<div class="strategy-spinner"></div>
<span>Analyzing Strategies...</span>
</div>
</div>
<nav class="flex items-center gap-8 text-sm font-medium text-gray-300">
<a class="hover:text-white transition-colors flex items-center gap-2" href="#" onclick="goBackToInterview()">
<span class="material-symbols-outlined text-lg">arrow_back</span>
Back to Interview
</a>
<a class="hover:text-white transition-colors flex items-center gap-2" href="#" onclick="viewAnalysisDetails()">
<span class="material-symbols-outlined text-lg">insights</span>
Analysis Details
</a>
</nav>
</header>

<!-- Main Strategy Panel -->
<main class="flex flex-1 justify-center py-12 px-6">
<div class="w-full max-w-6xl">

<!-- Strategy Title Section -->
<div class="text-center mb-12">
<h2 class="text-white tracking-tight text-5xl font-bold leading-tight mb-4">
🎯 Dr. Elena's Strategy Recommendations
</h2>
<p class="text-gray-400 text-xl leading-relaxed max-w-4xl mx-auto">
Expert Instructional Designer • Personalized E-Learning Strategies • Based on Your Content & SME Insights
</p>
<p id="strategy-content-summary" class="text-gray-500 text-lg mt-4 max-w-3xl mx-auto">
Analyzing your content and expert responses to recommend optimal e-learning strategies...
</p>
</div>

<!-- Strategy Analysis Progress -->
<div id="strategy-analysis-section" class="hidden mb-8">
<div class="strategy-panel">
<div class="flex items-center justify-between mb-6">
<h3 class="text-white text-2xl font-bold">Dr. Elena's Analysis</h3>
<div class="flex items-center gap-6 text-base text-gray-300">
<div>📊 Domain: <span id="content-domain" class="text-purple-300 font-semibold">--</span></div>
<div>🎯 Audience: <span id="target-audience" class="text-blue-300 font-semibold">--</span></div>
<div>📈 Strategies: <span id="recommended-count" class="text-green-300 font-semibold">--</span></div>
</div>
</div>
<div class="grid grid-cols-3 gap-6 mb-6">
<div class="bg-purple-900/40 border border-purple-500/30 rounded-xl p-6 text-center">
<div class="text-3xl font-bold text-purple-400 mb-2" id="content-score">0%</div>
<div class="text-gray-300">Content Suitability</div>
</div>
<div class="bg-blue-900/40 border border-blue-500/30 rounded-xl p-6 text-center">
<div class="text-3xl font-bold text-blue-400 mb-2" id="engagement-score">0%</div>
<div class="text-gray-300">Engagement Potential</div>
</div>
<div class="bg-green-900/40 border border-green-500/30 rounded-xl p-6 text-center">
<div class="text-3xl font-bold text-green-400 mb-2" id="learning-effectiveness">0%</div>
<div class="text-gray-300">Learning Effectiveness</div>
</div>
</div>
</div>
</div>

<!-- Strategy Recommendations Container -->
<div id="strategy-recommendations-container" class="hidden space-y-6">
<div class="strategy-panel mb-8">
<h3 class="text-white text-3xl font-bold mb-4 flex items-center gap-3">
<span class="material-symbols-outlined text-purple-400">lightbulb</span>
Recommended E-Learning Strategies
</h3>
<p class="text-gray-300 text-lg mb-6">
Based on your content analysis, Dr. Elena recommends these suitable e-learning strategies. <strong class="text-white">Please select the strategies that best fit your preferences and requirements.</strong>
</p>
<div class="bg-green-900/20 border border-green-500/30 rounded-lg p-6 mb-8">
<h4 class="text-green-300 font-semibold mb-3 flex items-center gap-2">
<span class="material-symbols-outlined">verified_user</span>
Dr. Elena's Expert Analysis
</h4>
<p id="expert-analysis-summary" class="text-green-100 text-base leading-relaxed">
Professional instructional designer analysis based on 20+ years of experience...
</p>
</div>
</div>

<!-- Strategy cards will be dynamically inserted here -->
<div id="strategy-cards-list"></div>

<!-- Selected Strategies Section -->
<div id="selected-strategies-section" class="hidden">
<div class="strategy-panel">
<h3 class="text-white text-2xl font-bold mb-6 flex items-center gap-3">
<span class="material-symbols-outlined text-green-400">check_circle</span>
Your Selected E-Learning Strategies
</h3>
<div id="selected-strategies-list" class="space-y-4 mb-8">
<!-- Selected strategies will be shown here -->
</div>
<div class="flex gap-6">
<button id="finalize-strategies-btn" onclick="finalizeStrategies()" 
        class="btn-strategy flex-1 disabled:opacity-50" disabled>
<span class="material-symbols-outlined mr-3">assignment_turned_in</span>
Finalize Strategy Selection
</button>
<button onclick="resetStrategySelection()" 
        class="flex-1 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 text-white py-4 px-8 rounded-xl font-semibold text-lg transition-all duration-300 flex items-center justify-center gap-3 border-2 border-gray-500/50">
<span class="material-symbols-outlined">refresh</span>
Reset Selection
</button>
</div>
</div>
</div>
</div>

<!-- Strategy Completion Section -->
<div id="strategy-completion-section" class="hidden text-center">
<div class="strategy-panel">
<div class="flex flex-col items-center gap-8">
<div class="w-32 h-32 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center border-4 border-white/20">
<span class="material-symbols-outlined text-6xl text-white">verified</span>
</div>
<div>
<h3 class="text-white text-4xl font-bold mb-4">Strategies Finalized!</h3>
<p class="text-gray-300 text-xl max-w-2xl">
Dr. Elena has analyzed your content and finalized the optimal e-learning strategies. Ready to create your personalized learning map.
</p>
</div>
<div class="grid grid-cols-3 gap-8 w-full max-w-2xl text-center">
<div class="bg-purple-900/40 border border-purple-500/30 rounded-xl p-6">
<div id="total-strategies" class="text-3xl font-bold text-purple-400 mb-2">0</div>
<div class="text-gray-300">Selected Strategies</div>
</div>
<div class="bg-blue-900/40 border border-blue-500/30 rounded-xl p-6">
<div id="implementation-time" class="text-3xl font-bold text-blue-400 mb-2">0</div>
<div class="text-gray-300">Weeks to Implement</div>
</div>
<div class="bg-green-900/40 border border-green-500/30 rounded-xl p-6">
<div class="text-3xl font-bold text-green-400 mb-2">✓</div>
<div class="text-gray-300">Ready for Learning Map</div>
</div>
</div>
<button id="proceed-to-learning-map" class="btn-strategy text-xl px-12 py-6" onclick="proceedToLearningMap()">
<span class="material-symbols-outlined mr-3">map</span>
Create Personalized Learning Map
</button>
</div>
</div>
</div>

</div>
</main>
</div>

<script>
// ===================================
// STRATEGY RECOMMENDATIONS SYSTEM
// ===================================

const BACKEND_URL = 'https://clamshell-backend-qbeqioz7a-mohammed-asrafs-projects.vercel.app';

// Strategy global state
let expertStrategyData = null;
let recommendedStrategies = [];
let selectedStrategies = [];
let analysisResults = null;

// Initialize strategy system
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Strategy Recommendations System Starting...');
    console.log('👩‍🏫 Expert: Dr. Elena Rodriguez - Instructional Designer');
    console.log('🎯 Purpose: E-Learning Strategy Analysis & Recommendations');
    
    // Load expert data
    expertStrategyData = getExpertStrategyData();
    
    console.log('🔍 Expert Data Detection:');
    console.log('   📊 Found Data:', !!expertStrategyData);
    console.log('   📝 SME Session:', expertStrategyData?.smeSessionId || 'Not found');
    console.log('   📄 Answers:', expertStrategyData?.submittedAnswers?.length || 0);
    
    if (expertStrategyData) {
        startStrategyAnalysis();
    } else {
        console.error('❌ No expert strategy data found');
        showStrategyError();
    }
});

// Get expert strategy data
function getExpertStrategyData() {
    console.log('🔍 Loading expert strategy data...');
    
    try {
        const stored = localStorage.getItem('expertStrategyData');
        if (stored) {
            const parsed = JSON.parse(stored);
            console.log('✅ Found expert data:', parsed.smeSessionId);
            return parsed;
        }
        
        console.log('❌ No expert strategy data found');
        return null;
        
    } catch (error) {
        console.error('❌ Error loading expert data:', error);
        return null;
    }
}

// Start strategy analysis
async function startStrategyAnalysis() {
    console.log('🚀 Dr. Elena analyzing strategies...');
    
    try {
        updateStrategyStatus('Dr. Elena Analyzing...', 'strategy-analyzing');
        
        // Simulate analysis process
        await simulateStrategyAnalysis();
        
        // Generate strategy recommendations
        recommendedStrategies = await generateStrategyRecommendations();

        // Display results
        displayStrategyAnalysis();
        displayStrategyRecommendations();
        
        updateStrategyStatus('Strategies Ready', 'strategy-ready');
        
    } catch (error) {
        console.error('❌ Strategy analysis failed:', error);
        showError('Strategy analysis failed: ' + error.message);
    }
}

// Simulate strategy analysis
async function simulateStrategyAnalysis() {
    const steps = [
        'Analyzing content domain...',
        'Processing SME responses...',
        'Identifying learning objectives...',
        'Evaluating audience characteristics...',
        'Matching optimal strategies...',
        'Calculating engagement scores...'
    ];
    
    for (let step of steps) {
        updateStrategyStatus(step, 'strategy-analyzing');
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
}

// Generate strategy recommendations with comprehensive analysis
async function generateStrategyRecommendations() {
    const contentDomain = expertStrategyData.contentAnalysis?.domainClassification?.contentType || 'General Training';
    const smeAnswers = expertStrategyData.submittedAnswers || [];

    console.log('🧠 Generating comprehensive AI strategy analysis for:', contentDomain);

    try {
        // Get real data from localStorage
        const professionalAnalysisData = localStorage.getItem('professionalAnalysisResults');
        const preSMEData = localStorage.getItem('preSMEAnswers');
        const smeInterviewData = localStorage.getItem('smeInterviewResults');
        const domainClassificationData = localStorage.getItem('domainClassificationResults');
        const courseId = localStorage.getItem('courseId');

        const analysisData = professionalAnalysisData ? JSON.parse(professionalAnalysisData) : {};
        const preSME = preSMEData ? JSON.parse(preSMEData) : {};
        const smeData = smeInterviewData ? JSON.parse(smeInterviewData) : {};
        const domainData = domainClassificationData ? JSON.parse(domainClassificationData) : {};

        console.log('📊 Real data loaded:', {
            analysisData: !!analysisData.data,
            preSME: Object.keys(preSME).length,
            smeAnswers: smeData.answers ? Object.keys(smeData.answers).length : 0,
            domain: domainData.domain || domainData.data?.domain,
            courseId
        });

        const response = await fetch(`${BACKEND_URL}/api/generate-strategies`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                content: analysisData.data?.content || '',
                analysisData: analysisData.data || {},
                preSMEAnswers: preSME,
                smeAnswers: smeData.answers ? Object.values(smeData.answers) : [],
                domain: domainData.domain || domainData.data?.domain || 'General',
                courseId: courseId,
                selectedFramework: preSME.instructionalFrameworks ? preSME.instructionalFrameworks.join(', ') : 'Not specified',
                contentTopics: analysisData.data?.topics || analysisData.data?.mainTopics || 'General training content',
                wordCount: analysisData.data?.wordCount || 0,
                clientName: preSME.clientName || 'To Be Determined'
            })
        });

        if (response.ok) {
            const result = await response.json();
            console.log('✅ AI strategy generation successful:', result);

            if (result.success && result.strategies) {
                console.log('🎯 Converting AI strategies to frontend format');

                // Store strategies data for display
                if (result.strategies.recommendation) {
                    window.comprehensiveAnalysis = result.strategies.recommendation;
                }
                if (result.strategies.domainSpecificInsights) {
                    window.domainInsights = result.strategies.domainSpecificInsights;
                }

                // Convert strategies array to frontend format
                return convertAIStrategiesToFrontend(result.strategies, contentDomain);
            } else {
                console.warn('⚠️ Invalid strategy response format');
            }
        } else {
            console.warn('⚠️ AI strategy generation failed, using enhanced fallback');
        }
    } catch (error) {
        console.error('❌ Strategy generation error:', error);
        console.error('⚠️ NO FALLBACK AVAILABLE - AI backend required for strategies');

        // Show error to user - NO FAKE DATA
        if (typeof showBackendError === 'function') {
            showBackendError('Strategy generation requires AI backend connection. Please ensure the backend server is running at https://clamshell-backend-qbeqioz7a-mohammed-asrafs-projects.vercel.app');
        }

        // Return empty array - NO FAKE DATA
        return [];
    }

    // This line should never be reached
    console.error('❌ CRITICAL: Reached unreachable code - no strategies available');
    return [];
}

// Convert AI-generated strategies to frontend format
function convertAIStrategiesToFrontend(strategiesData, contentDomain) {
    console.log('🔄 Converting AI strategies to frontend format');
    console.log('📊 Strategies data:', strategiesData);

    const strategies = [];

    // Extract strategies from the response
    if (strategiesData.strategies && Array.isArray(strategiesData.strategies)) {
        strategiesData.strategies.forEach((strategy, index) => {
            strategies.push({
                id: `ai_strategy_${strategy.id}_${Date.now()}_${index}`,
                name: strategy.name,
                type: strategy.deliveryFormat?.toLowerCase().replace(/\s+/g, '_') || 'strategy',
                description: strategy.description,
                suitability: strategy.suitabilityScore || 85,
                implementation: strategy.estimatedDuration || 'Variable',
                benefits: strategy.keyFeatures || strategy.expectedOutcomes || [],
                ideal_for: [strategy.targetAudience, contentDomain],
                expert_rationale: strategy.rationale,
                framework_based: true,
                ai_enhanced: true,
                icon: index === 0 ? 'star' : 'lightbulb',
                color: index === 0 ? 'gold' : 'blue',
                use_cases: strategy.advantages || [],
                implementation_details: {
                    duration: strategy.estimatedDuration,
                    complexity: strategy.complexity || 'Medium',
                    resources: strategy.technologyRequirements,
                    timeframe: strategy.estimatedDuration
                }
            });
        });
    }

    // Store recommendation analysis for display
    if (strategiesData.recommendation) {
        window.comprehensiveAnalysis = strategiesData.recommendation;
        console.log('💡 Recommendation stored:', strategiesData.recommendation);
    }

    // Store domain insights
    if (strategiesData.domainSpecificInsights) {
        window.domainInsights = strategiesData.domainSpecificInsights;
        console.log('📚 Domain insights stored');
    }

    console.log(`✅ Converted ${strategies.length} AI strategies to frontend format`);
    return strategies.filter(s => s.suitability >= 70);
}

// Helper functions for data conversion
function convertSMEAnswersToObject(smeAnswers) {
    const answersObject = {};
    smeAnswers.forEach((answer, index) => {
        answersObject[index] = answer.text || answer || '';
    });
    return answersObject;
}

function calculateCompletionRate(smeAnswers) {
    if (!smeAnswers || smeAnswers.length === 0) return 0;
    const completed = smeAnswers.filter(answer => answer && answer.text && answer.text.trim().length > 0).length;
    return Math.round((completed / smeAnswers.length) * 100);
}

function extractSMEQuestions() {
    // Extract questions from the SME interview data or return defaults
    return expertStrategyData.smeQuestions || [
        'What are your main learning objectives?',
        'Who is your target audience?',
        'What delivery method do you prefer?',
        'How do you want to assess learning?'
    ];
}

// Convert comprehensive AI analysis to frontend strategy format
function convertComprehensiveAnalysisToStrategies(analysis, contentDomain) {
    console.log('🔄 Converting comprehensive AI analysis to frontend format');
    console.log('📊 Analysis structure:', analysis);

    const strategies = [];

    // Extract strategies from comprehensive analysis
    if (analysis.recommendedStrategies && Array.isArray(analysis.recommendedStrategies)) {
        analysis.recommendedStrategies.forEach((strategy, index) => {
            strategies.push({
                id: `comprehensive_${strategy.strategyName?.replace(/\s+/g, '_').toLowerCase()}_${Date.now()}_${index}`,
                name: strategy.strategyName,
                type: strategy.learningApproach?.toLowerCase().replace(/\s+/g, '_') || 'comprehensive_strategy',
                description: strategy.detailedReasoning,
                suitability: strategy.suitabilityScore || 85,
                implementation: strategy.implementationTimeline || 'Implementation timeline varies',
                benefits: strategy.keyBenefits || ['Addresses content gaps', 'Supports learning objectives'],
                ideal_for: [contentDomain, strategy.targetAudience || 'Professional learners'],
                expert_rationale: `Why recommended for your content: ${strategy.whySuitableForContent}`,
                framework_based: true,
                ai_enhanced: true,
                enhancement_type: 'comprehensive_analysis',
                icon: index === 0 ? 'star' : 'lightbulb',
                color: index === 0 ? 'gold' : 'blue',
                use_cases: strategy.useCases || [],
                implementation_details: {
                    timeframe: strategy.implementationTimeline,
                    complexity: strategy.complexity || 'Medium',
                    resources: strategy.requiredResources,
                    successFactors: strategy.successFactors
                },
                content_specific_details: {
                    whySuitable: strategy.whySuitableForContent,
                    contentAlignment: strategy.contentAlignment,
                    learningObjectives: strategy.learningObjectives,
                    engagementFactors: strategy.engagementFactors
                }
            });
        });
    }

    // Store comprehensive analysis for display
    if (analysis.overallAnalysis) {
        window.comprehensiveAnalysis = analysis.overallAnalysis;
        console.log('💡 Comprehensive Analysis stored:', analysis.overallAnalysis);
    }

    // Store content scores if available
    if (analysis.contentAssessment) {
        window.contentScores = {
            contentSuitability: analysis.contentAssessment.suitabilityScore || 85,
            engagementPotential: analysis.contentAssessment.engagementPotential || 80,
            learningEffectiveness: analysis.contentAssessment.learningEffectiveness || 82
        };
        console.log('📊 Content scores stored:', window.contentScores);
    }

    console.log(`✅ Converted ${strategies.length} comprehensive strategies to frontend format`);
    return strategies.filter(s => s.suitability >= 75); // Show strategies with good suitability
}

// Enhanced content-specific strategy generation fallback - DISABLED (Requires AI Backend)
function generateEnhancedContentSpecificStrategies(contentDomain, smeAnswers) {
    console.error('❌ FATAL ERROR: generateEnhancedContentSpecificStrategies called without AI backend');
    console.error('This function contains hardcoded fake data and has been disabled');
    console.error('AI backend must be running at https://clamshell-backend-qbeqioz7a-mohammed-asrafs-projects.vercel.app');

    showBackendError('Strategy generation requires AI backend. This function has been disabled to prevent showing fake data. Please start the backend server at https://clamshell-backend-qbeqioz7a-mohammed-asrafs-projects.vercel.app');

    throw new Error('HARDCODED_FALLBACK_DISABLED: AI backend required for strategy generation');
}

// Convert AI-generated strategy recommendations to frontend format (LEGACY - for backward compatibility)
function convertAIRecommendationsToFrontend(recommendations, contentDomain) {
    console.log('🔄 Converting AI Action Mapping recommendations to frontend format');
    console.log('📊 Recommendations structure:', recommendations);

    const strategies = [];

    // Convert selected strategies from the new format
    if (recommendations.selectedStrategies && Array.isArray(recommendations.selectedStrategies)) {
        recommendations.selectedStrategies.forEach((strategy, index) => {
            strategies.push({
                id: `strategy_${strategy.strategyNumber}_${Date.now()}_${index}`,
                name: strategy.strategyName,
                type: index === 0 ? 'primary_strategy' : 'supporting_strategy',
                description: strategy.cathyMooreRationale,
                suitability: strategy.confidence || 85,
                implementation: strategy.implementationDetails?.timeframe || 'Implementation timeline varies',
                benefits: strategy.addressesGaps || ['Addresses content gaps', 'Supports business goals'],
                ideal_for: [contentDomain, 'Cathy Moore Action Mapping approach'],
                expert_rationale: `Action Mapping Analysis: ${strategy.cathyMooreRationale}`,
                framework_based: true,
                ai_enhanced: true,
                enhancement_type: 'action_mapping_selected',
                icon: index === 0 ? 'star' : 'support',
                color: index === 0 ? 'gold' : 'blue',
                use_cases: [strategy.businessAlignment, strategy.behaviorSupport].filter(Boolean),
                implementation_details: {
                    timeframe: strategy.implementationDetails?.timeframe,
                    complexity: strategy.implementationDetails?.complexity,
                    resources: strategy.implementationDetails?.resources,
                    successFactors: strategy.implementationDetails?.criticalSuccessFactors
                },
                action_mapping_details: {
                    businessAlignment: strategy.businessAlignment,
                    behaviorSupport: strategy.behaviorSupport,
                    practiceDesign: strategy.practiceDesign,
                    addressedGaps: strategy.addressesGaps
                }
            });
        });
    }

    // Add Action Mapping context if available
    if (recommendations.actionMappingAnalysis) {
        // Store action mapping analysis for display
        window.actionMappingAnalysis = recommendations.actionMappingAnalysis;
        console.log('💡 Action Mapping Analysis stored:', recommendations.actionMappingAnalysis);
    }

    // Store strategy integration details
    if (recommendations.strategyIntegration) {
        window.strategyIntegration = recommendations.strategyIntegration;
        console.log('🔗 Strategy Integration stored:', recommendations.strategyIntegration);
    }

    console.log(`✅ Converted ${strategies.length} Action Mapping strategies to frontend format`);
    return strategies.filter(s => s.suitability >= 80); // Only show high-suitability strategies
}


// Filtered fallback strategies (only high-suitability)
function generateFilteredFallbackStrategies(contentDomain, smeAnswers) {
    console.log('🔄 Using filtered fallback strategies for:', contentDomain);

    const availableStrategies = [
        {
            id: 'microlearning',
            name: 'Microlearning Modules',
            type: 'microlearning',
            description: 'Bite-sized learning modules delivered in 3-5 minute segments for better retention and engagement.',
            suitability: 88, // Reduced from 95 to be more realistic
            implementation: '2-3 weeks',
            benefits: ['High retention rates', 'Flexible learning pace', 'Mobile-friendly'],
            ideal_for: ['Busy professionals', 'Skill-building', 'Knowledge refreshers'],
            expert_rationale: 'Perfect for modern learners with limited time. Breaks complex topics into digestible chunks.'
        },
        {
            id: 'interactive_scenarios',
            name: 'Interactive Scenarios',
            type: 'interactive',
            description: 'Realistic workplace scenarios where learners make decisions and see consequences.',
            suitability: 85,
            implementation: '3-4 weeks',
            benefits: ['Practical application', 'Critical thinking', 'Real-world relevance'],
            ideal_for: ['Decision-making skills', 'Problem-solving', 'Soft skills'],
            expert_rationale: 'Excellent for applying knowledge in realistic contexts. Builds decision-making confidence.'
        },
        {
            id: 'simulation_training',
            name: 'Virtual Simulations',
            type: 'simulation',
            description: 'Virtual environment simulations for safe practice of high-risk or complex procedures.',
            suitability: 90,
            implementation: '5-6 weeks',
            benefits: ['Risk-free practice', 'Realistic experience', 'Skill mastery'],
            ideal_for: ['Technical skills', 'Safety training', 'Complex procedures'],
            expert_rationale: 'Essential for high-stakes learning. Allows unlimited practice without real-world risks.'
        }
    ];

    // Only return high-suitability strategies (80+) - filtering out less suitable ones
    return availableStrategies.filter(strategy => strategy.suitability >= 80);
}

// Extract timeframe from implementation steps
function extractTimeframe(steps) {
    if (!steps || !Array.isArray(steps)) return '4-6 weeks';
    return steps.length <= 3 ? '2-4 weeks' : '4-8 weeks';
}

// Extract benefits from implementation steps
function extractBenefits(steps) {
    if (!steps || !Array.isArray(steps)) return ['Expert-designed approach'];
    return steps.slice(0, 3).map(step => step.split(':')[0].replace('Step ', 'Phase '));
}

// Get session ID from URL or storage
function getSessionId() {
    // Try URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    let sessionId = urlParams.get('sessionId');

    // Try localStorage
    if (!sessionId) {
        sessionId = localStorage.getItem('currentSessionId');
    }

    // Generate new session ID if none found
    if (!sessionId) {
        sessionId = 'session_' + Date.now();
        localStorage.setItem('currentSessionId', sessionId);
    }

    return sessionId;
}

// Rank strategies based on domain and SME answers
function rankStrategiesForDomain(strategies, domain, smeAnswers) {
    console.log('📊 Ranking strategies for domain:', domain);
    
    // Adjust suitability based on domain
    const domainPreferences = {
        'Technical Training': {
            'simulation_training': +10,
            'interactive_scenarios': +8,
            'microlearning': +5
        },
        'Business Training': {
            'interactive_scenarios': +10,
            'social_learning': +8,
            'blended_approach': +6
        },
        'Healthcare Training': {
            'simulation_training': +15,
            'interactive_scenarios': +10,
            'microlearning': +5
        },
        'Safety Training': {
            'simulation_training': +12,
            'interactive_scenarios': +8,
            'gamification': -5
        }
    };
    
    const preferences = domainPreferences[domain] || {};
    
    // Apply domain adjustments
    const adjustedStrategies = strategies.map(strategy => ({
        ...strategy,
        suitability: Math.min(100, strategy.suitability + (preferences[strategy.id] || 0)),
        domain_fit: preferences[strategy.id] ? 'High' : 'Medium'
    }));
    
    // Sort by suitability
    return adjustedStrategies.sort((a, b) => b.suitability - a.suitability);
}

// Update strategy status
function updateStrategyStatus(text, className) {
    const statusEl = document.getElementById('strategy-status');
    if (!statusEl) return;
    
    statusEl.className = `strategy-badge ${className}`;
    
    const icon = className === 'strategy-analyzing' ? '<div class="strategy-spinner"></div>' :
                 className === 'strategy-ready' ? '<span class="material-symbols-outlined">lightbulb</span>' :
                 '<span class="material-symbols-outlined">check_circle</span>';
    
    statusEl.innerHTML = `${icon}<span>${text}</span>`;
}

// Display strategy analysis
function displayStrategyAnalysis() {
    console.log('📋 Displaying strategy analysis...');
    
    const contentDomain = expertStrategyData.contentAnalysis?.domainClassification?.contentType || 'General Training';
    const suitabilityScore = expertStrategyData.contentAnalysis?.suitabilityAssessment?.score || 75;
    
    // Update summary
    document.getElementById('strategy-content-summary').textContent = 
        `Dr. Elena analyzed your ${contentDomain} content and ${expertStrategyData.submittedAnswers?.length || 0} expert responses`;
    
    // Update analysis section
    document.getElementById('content-domain').textContent = contentDomain;
    document.getElementById('target-audience').textContent = 'Professional Learners';
    document.getElementById('recommended-count').textContent = `${recommendedStrategies.length} available`;

    // Use enhanced content scores if available, otherwise fallback to calculated scores
    let contentSuitabilityScore = suitabilityScore;
    let engagementScore = Math.min(95, suitabilityScore + 10);
    let learningEffectivenessScore = Math.min(90, suitabilityScore + 5);

    if (window.contentScores) {
        console.log('📊 Using enhanced content scores:', window.contentScores);
        contentSuitabilityScore = window.contentScores.contentSuitability || contentSuitabilityScore;
        engagementScore = window.contentScores.engagementPotential || engagementScore;
        learningEffectivenessScore = window.contentScores.learningEffectiveness || learningEffectivenessScore;
    }

    // Animate scores with enhanced values
    animateScore('content-score', contentSuitabilityScore);
    animateScore('engagement-score', engagementScore);
    animateScore('learning-effectiveness', learningEffectivenessScore);
    
    // Update expert analysis summary
    let expertSummary = generateExpertAnalysisSummary(contentDomain, suitabilityScore);

    // Use AI-generated expert analysis if available
    if (window.comprehensiveAnalysis && window.comprehensiveAnalysis.reasoning) {
        expertSummary = window.comprehensiveAnalysis.reasoning;
    } else if (window.domainInsights && window.domainInsights.length > 0) {
        expertSummary = window.domainInsights.join(' ');
    }

    document.getElementById('expert-analysis-summary').textContent = expertSummary;
    
    document.getElementById('strategy-analysis-section').classList.remove('hidden');
}

// Generate expert analysis summary
function generateExpertAnalysisSummary(domain, score) {
    const summaries = {
        'Technical Training': `Your technical content shows excellent potential for interactive e-learning. With ${score}% suitability, I recommend simulation-based approaches with hands-on practice components.`,
        'Business Training': `This business content is well-suited for scenario-based learning. The ${score}% suitability score indicates strong potential for case studies and collaborative exercises.`,
        'Healthcare Training': `Your healthcare content requires high-fidelity learning approaches. With ${score}% suitability, virtual simulations and interactive scenarios will ensure safe, effective skill development.`,
        default: `Your content shows ${score}% suitability for e-learning conversion. I recommend a multi-modal approach combining interactive elements with practical applications.`
    };
    
    return summaries[domain] || summaries.default;
}

// Display strategy recommendations
function displayStrategyRecommendations() {
    console.log('🎯 Displaying strategy recommendations...');

    const container = document.getElementById('strategy-recommendations-container');
    const cardsList = document.getElementById('strategy-cards-list');

    cardsList.innerHTML = '';

    // Ensure recommendedStrategies is an array
    if (!Array.isArray(recommendedStrategies)) {
        console.error('❌ recommendedStrategies is not an array:', typeof recommendedStrategies, recommendedStrategies);
        recommendedStrategies = [];
    }

    if (recommendedStrategies.length === 0) {
        cardsList.innerHTML = '<div class="text-yellow-400 text-center p-8">⚠️ No strategies available. Please try refreshing the page.</div>';
        return;
    }

    console.log('🐛 DEBUG: recommendedStrategies array:', recommendedStrategies.map(s => ({id: s.id, name: s.name})));

    recommendedStrategies.forEach((strategy, index) => {
        console.log(`🐛 DEBUG: Creating card for strategy ${index}:`, {id: strategy.id, name: strategy.name});
        const card = createStrategyCard(strategy, index);
        cardsList.appendChild(card);
    });

    // Auto-select top recommended strategies after all cards are added to DOM
    setTimeout(() => {
        initializeStrategySelection();
        updateSelectedStrategiesDisplay();

        // Let users choose their preferred strategies - no fallback selection
        console.log('✅ Strategies displayed - user can select their preferred options');

        console.log(`🎯 Final selected strategies count: ${selectedStrategies.length}`);
    }, 100);
    
    container.classList.remove('hidden');
    
    console.log(`✅ Displayed ${recommendedStrategies.length} strategy recommendations`);
}

// Create strategy card
function createStrategyCard(strategy, index) {
    const card = document.createElement('div');
    card.className = `strategy-card ${index < 3 ? 'recommended' : ''}`;
    card.id = `strategy-${strategy.id}`;

    const typeClass = `type-${strategy.type}`;
    const isRecommended = index < 3;

    card.innerHTML = `
        <div class="flex items-start gap-4 mb-6">
            <div class="flex-shrink-0">
                <input type="checkbox" id="select-${strategy.id}"
                       class="w-6 h-6 rounded border-2 border-purple-500 text-purple-500 focus:ring-purple-500 focus:ring-2"
                       onchange="toggleStrategySelection('${strategy.id}', this.checked)">
            </div>
            <div class="flex-1">
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <span class="strategy-type-badge ${typeClass}">
                        <span class="material-symbols-outlined mr-1">${strategy.icon || 'lightbulb'}</span>
                        ${strategy.type.replace('_', ' ').toUpperCase()}
                    </span>
                    ${strategy.framework_based ? '<span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">EVIDENCE-BASED</span>' : ''}
                    ${strategy.ai_enhanced ? '<span class="bg-purple-600 text-white px-2 py-1 rounded text-xs">AI-ENHANCED</span>' : ''}
                    ${isRecommended ? '<span class="text-green-400 text-sm font-semibold">• TOP RECOMMENDATION</span>' : ''}
                </div>
                <h4 class="text-white text-2xl font-bold mb-3">${strategy.name}</h4>
                <p class="text-gray-300 text-base mb-4 leading-relaxed">${strategy.description}</p>
                
                <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 mb-4">
                    <h5 class="text-purple-300 font-semibold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined">psychology</span>
                        ${strategy.framework_based ? 'Evidence-Based Analysis' : 'Expert Analysis'}
                    </h5>
                    <p class="text-purple-100 text-sm italic">"${strategy.expert_rationale || strategy.description}"</p>
                    ${strategy.use_cases && strategy.use_cases.length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-purple-500/20">
                            <h6 class="text-purple-200 font-medium text-xs mb-2">Common Use Cases:</h6>
                            <div class="flex flex-wrap gap-2">
                                ${strategy.use_cases.slice(0, 3).map(useCase =>
                                    `<span class="bg-purple-700/30 text-purple-200 px-2 py-1 rounded text-xs">${useCase}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                        <h6 class="text-green-300 font-semibold mb-2 text-sm">Key Benefits:</h6>
                        <ul class="text-green-100 text-xs space-y-1">
                            ${strategy.benefits.map(benefit => `<li>• ${benefit}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3">
                        <h6 class="text-blue-300 font-semibold mb-2 text-sm">Ideal For:</h6>
                        <ul class="text-blue-100 text-xs space-y-1">
                            ${strategy.ideal_for.map(item => `<li>• ${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3">
                        <h6 class="text-yellow-300 font-semibold mb-2 text-sm">Implementation:</h6>
                        <div class="text-yellow-100 text-xs space-y-1">
                            <p><strong>Duration:</strong> ${strategy.implementation_details?.duration || strategy.implementation || 'Medium timeframe'}</p>
                            <p><strong>Complexity:</strong> ${strategy.implementation_details?.complexity || 'Medium'}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span>Match Score:</span>
                                <div class="flex-1 bg-gray-700 rounded-full h-2">
                                    <div class="bg-yellow-400 h-2 rounded-full" style="width: ${strategy.suitability || 85}%"></div>
                                </div>
                                <span class="font-semibold">${strategy.suitability || 85}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

// Display strategies without auto-selection - let users choose
function initializeStrategySelection() {
    console.log('🎯 Initializing strategy selection (no auto-selection)');

    // Clear any existing selections
    selectedStrategies = [];

    // Initialize all strategies as unselected
    recommendedStrategies.forEach((strategy) => {
        const checkbox = document.getElementById(`select-${strategy.id}`);
        const card = document.getElementById(`strategy-${strategy.id}`);

        if (checkbox && card) {
            checkbox.checked = false;
            card.classList.remove('recommended', 'selected');
            console.log('📋 Strategy available for selection:', strategy.name || strategy.strategyName);
        }
    });

    // Update the UI to reflect no selections
    updateSelectionCount();

    console.log(`✅ ${recommendedStrategies.length} strategies available for user selection`);
}

// Toggle strategy selection with enhanced UI feedback
function toggleStrategySelection(strategyId, checked) {
    console.log(`🎯 Strategy selection toggled: ${strategyId} = ${checked}`);

    const strategy = recommendedStrategies.find(s => s.id === strategyId);
    if (!strategy) {
        console.error('❌ Strategy not found:', strategyId);
        console.error('🐛 DEBUG: Searching for ID:', strategyId, 'in strategies:', recommendedStrategies.map(s => s.id));
        console.error('🐛 DEBUG: Strategy ID types:', recommendedStrategies.map(s => `${s.id} (${typeof s.id})`));
        return;
    }

    const card = document.getElementById(`strategy-${strategyId}`);
    const checkbox = document.getElementById(`select-${strategyId}`);

    if (checked) {
        // Add to selected strategies if not already there
        if (!selectedStrategies.find(s => s.id === strategyId)) {
            selectedStrategies.push(strategy);
            console.log(`✅ Added strategy: ${strategy.name}`);
        }

        // Add visual indicators
        card.classList.add('recommended');
        card.style.transform = 'translateY(-2px)';
        card.style.boxShadow = '0 8px 25px rgba(34, 197, 94, 0.3)';
        card.style.borderColor = 'rgba(34, 197, 94, 0.6)';

        // Add selection indicator
        if (!card.querySelector('.selection-indicator')) {
            const indicator = document.createElement('div');
            indicator.className = 'selection-indicator absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1';
            indicator.innerHTML = '<span class="material-symbols-outlined text-xs">check_circle</span>SELECTED';
            card.style.position = 'relative';
            card.appendChild(indicator);
        }
    } else {
        // Remove from selected strategies
        selectedStrategies = selectedStrategies.filter(s => s.id !== strategyId);
        console.log(`❌ Removed strategy: ${strategy.name}`);

        // Remove visual indicators
        card.classList.remove('recommended');
        card.style.transform = '';
        card.style.boxShadow = '';
        card.style.borderColor = '';

        // Remove selection indicator
        const indicator = card.querySelector('.selection-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    // Update displays with real-time feedback
    updateSelectedStrategiesDisplay();
    updateSelectionCount();

    // Store selected strategies in localStorage for persistence
    localStorage.setItem('selectedStrategies', JSON.stringify(selectedStrategies.map(s => s.id)));

    console.log(`📊 Current selection count: ${selectedStrategies.length}`);
}

// Update selected strategies display
function updateSelectedStrategiesDisplay() {
    console.log('🔄 Updating selected strategies display...', selectedStrategies.length, 'strategies selected');

    const section = document.getElementById('selected-strategies-section');
    const list = document.getElementById('selected-strategies-list');
    const finalizeBtn = document.getElementById('finalize-strategies-btn');

    console.log('📋 UI Elements found:', {
        section: !!section,
        list: !!list,
        finalizeBtn: !!finalizeBtn
    });

    if (selectedStrategies.length > 0) {
        list.innerHTML = selectedStrategies.map(strategy => `
            <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-green-400">check_circle</span>
                    <div>
                        <h5 class="text-white font-semibold">${strategy.title || strategy.name}</h5>
                        <p class="text-gray-300 text-sm">Implementation: ${strategy.implementation_details?.duration || strategy.implementation || 'Medium timeframe'} • Suitability: ${strategy.score || strategy.suitability || 85}%</p>
                    </div>
                </div>
            </div>
        `).join('');
        
        section.classList.remove('hidden');
        finalizeBtn.disabled = false;
        finalizeBtn.classList.remove('opacity-50');

        console.log('✅ Continue button enabled! Section shown.');
    } else {
        section.classList.add('hidden');
        finalizeBtn.disabled = true;
        finalizeBtn.classList.add('opacity-50');

        console.log('❌ Continue button disabled. No strategies selected.');
    }
}

// Update selection count display
function updateSelectionCount() {
    // Update counter in the main header to show selections vs available
    const countDisplay = document.getElementById('recommended-count');
    if (countDisplay) {
        if (selectedStrategies.length > 0) {
            countDisplay.textContent = `${selectedStrategies.length} selected of ${recommendedStrategies.length}`;
            countDisplay.className = 'text-green-400 font-semibold';
        } else {
            countDisplay.textContent = `${recommendedStrategies.length} available`;
            countDisplay.className = 'text-white font-semibold';
        }
    }

    // Update any selection count indicators
    const selectionCounters = document.querySelectorAll('.selection-counter');
    selectionCounters.forEach(counter => {
        counter.textContent = selectedStrategies.length;
    });

    // Show selection feedback in header if exists
    const selectionFeedback = document.getElementById('selection-feedback');
    if (selectionFeedback) {
        if (selectedStrategies.length > 0) {
            selectionFeedback.textContent = `${selectedStrategies.length} strategy${selectedStrategies.length !== 1 ? 'ies' : ''} selected`;
            selectionFeedback.className = 'text-green-400 text-sm font-medium';
        } else {
            selectionFeedback.textContent = 'No strategies selected';
            selectionFeedback.className = 'text-yellow-400 text-sm font-medium';
        }
    }

    console.log(`📊 Selection count updated: ${selectedStrategies.length} strategies`);
}

// Finalize strategies
function finalizeStrategies() {
    console.log('✅ Finalizing strategy selection...');
    
    if (selectedStrategies.length === 0) {
        alert('Please select at least one strategy to finalize.');
        return;
    }
    
    const finalizeBtn = document.getElementById('finalize-strategies-btn');
    finalizeBtn.disabled = true;
    finalizeBtn.innerHTML = '<div class="strategy-spinner mr-3"></div>Finalizing Strategies...';
    
    // Store finalized strategies
    const finalizedData = {
        ...expertStrategyData,
        selectedStrategies: selectedStrategies,
        strategiesFinalized: true,
        finalizedAt: new Date().toISOString(),
        nextPhase: 'learning_map_creation',
        totalImplementationTime: selectedStrategies.reduce((total, s) => {
            const weeks = parseInt(s.implementation.match(/\d+/)?.[0] || 3);
            return total + weeks;
        }, 0)
    };
    
    localStorage.setItem('finalizedStrategies', JSON.stringify(finalizedData));

    // Send selected strategies to backend
    storeSelectedStrategiesInBackend(selectedStrategies).then(() => {
        setTimeout(() => {
            showStrategyCompletion(finalizedData);
        }, 2000);
    }).catch(error => {
        console.error('❌ Failed to store strategies in backend:', error);
        // Continue anyway to not break user flow
        setTimeout(() => {
            showStrategyCompletion(finalizedData);
        }, 2000);
    });
}

// Store selected strategies in backend
async function storeSelectedStrategiesInBackend(strategies) {
    try {
        const sessionId = getSessionId();
        if (!sessionId) {
            throw new Error('No session ID found');
        }

        console.log('📤 Sending selected strategies to backend:', strategies.length);

        const response = await fetch(`${BACKEND_URL}/api/store-selected-strategies`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sessionId: sessionId,
                selectedStrategies: strategies
            })
        });

        if (!response.ok) {
            throw new Error(`Backend error: ${response.status}`);
        }

        const result = await response.json();
        console.log('✅ Strategies stored in backend:', result);
        return result;

    } catch (error) {
        console.error('❌ Error storing strategies in backend:', error);
        throw error;
    }
}

// Show strategy completion
function showStrategyCompletion(data) {
    // Hide previous sections
    document.getElementById('strategy-recommendations-container').classList.add('hidden');
    
    // Update completion stats
    document.getElementById('total-strategies').textContent = selectedStrategies.length;
    document.getElementById('implementation-time').textContent = data.totalImplementationTime;
    
    // Show completion section
    document.getElementById('strategy-completion-section').classList.remove('hidden');
    
    updateStrategyStatus('Strategies Finalized', 'strategy-complete');
    
    console.log('✅ Strategy recommendations completed');
}

// Proceed to learning map
function proceedToLearningMap() {
    console.log('🗺️ Proceeding to learning map creation...');
    
    const proceedBtn = document.getElementById('proceed-to-learning-map');
    proceedBtn.disabled = true;
    proceedBtn.innerHTML = '<div class="strategy-spinner mr-3"></div>Creating Learning Map...';
    
    setTimeout(() => {
        alert('🎯 Strategies Finalized!\n\nDr. Elena has successfully analyzed your content and finalized optimal e-learning strategies.\n\nProceeding to create your personalized learning map...');
        
        // UNCOMMENT AND UPDATE PATH TO YOUR LEARNING MAP PAGE:
        window.location.href = '../personalized_learning_map/code.html';
    }, 3000);
}

// Reset strategy selection
function resetStrategySelection() {
    if (confirm('Are you sure you want to reset your strategy selection?')) {
        // Uncheck all checkboxes
        selectedStrategies = [];
        recommendedStrategies.forEach(strategy => {
            const checkbox = document.getElementById(`select-${strategy.id}`);
            const card = document.getElementById(`strategy-${strategy.id}`);
            
            if (checkbox) checkbox.checked = false;
            if (card) card.classList.remove('recommended');
        });
        
        updateSelectedStrategiesDisplay();
        console.log('🔄 Strategy selection reset');
    }
}

// Show strategy error
function showStrategyError() {
    const errorMessage = `Strategy System Error: No expert data found.

Required Data Missing:
• SME interview responses
• Content analysis results  
• Expert strategy session

Please complete the SME interview first.`;

    showError(errorMessage);
    
    setTimeout(() => {
        console.log('📍 Redirecting to SME interview...');
        // UNCOMMENT when you have the correct path:
         window.location.href = '../brand_checklist_&_sme_interview/code.html';
    }, 5000);
}

// Enhanced error display
function showError(message) {
    console.error('❌ Strategy System Error:', message);
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    errorDiv.innerHTML = `
        <div class="bg-red-900 text-white p-8 rounded-lg shadow-2xl max-w-2xl mx-4">
            <div class="flex items-center gap-4 mb-6">
                <span class="material-symbols-outlined text-4xl">error</span>
                <div>
                    <h2 class="text-2xl font-bold">Strategy System Error</h2>
                    <p class="text-red-200">Required data not found</p>
                </div>
            </div>
            <div class="bg-black bg-opacity-30 p-4 rounded mb-6">
                <pre class="text-sm text-red-100 whitespace-pre-wrap">${message}</pre>
            </div>
            <div class="flex gap-4">
                <button onclick="location.reload()" 
                        class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded font-bold">
                    Try Again
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        class="bg-gray-800 hover:bg-gray-900 px-6 py-3 rounded font-bold">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(errorDiv);
}

// Navigation functions
function goBackToInterview() {
    if (confirm('Are you sure you want to go back? Your strategy selection will be lost.')) {
        alert('Returning to SME interview...');
        // UNCOMMENT when you have the correct path:
         window.location.href = '../brand_checklist_&_sme_interview/code.html';
    }
}

function viewAnalysisDetails() {
    const details = `Dr. Elena's Analysis Details:

Content Domain: ${expertStrategyData?.contentAnalysis?.domainClassification?.contentType || 'Unknown'}
SME Responses: ${expertStrategyData?.submittedAnswers?.length || 0}
Content Suitability: ${expertStrategyData?.contentAnalysis?.suitabilityAssessment?.score || 0}%
Quality Score: ${expertStrategyData?.contentAnalysis?.qualityAssessment?.overallScore || 0}%
Recommended Strategies: ${recommendedStrategies.length}
Selected Strategies: ${selectedStrategies.length}`;

    alert(details);
}

// Animate score function
function animateScore(elementId, targetScore) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    let current = 0;
    const increment = targetScore / 60;
    
    const animate = () => {
        current += increment;
        if (current < targetScore) {
            element.textContent = Math.round(current) + '%';
            requestAnimationFrame(animate);
        } else {
            element.textContent = targetScore + '%';
        }
    };
    
    animate();
}

// Initialize selected strategies display on load
setTimeout(() => {
    if (selectedStrategies.length > 0) {
        updateSelectedStrategiesDisplay();
    }
}, 1000);

console.log('✅ Strategy Recommendations System Ready!');
console.log('👩‍🏫 Expert: Dr. Elena Rodriguez - Instructional Designer');  
console.log('🎯 Purpose: E-Learning Strategy Analysis & Recommendations');
console.log('🧠 Capabilities: Domain-specific strategy matching, expert analysis');
console.log('📊 Flow: SME Interview → Strategy Analysis → Learning Map Creation');
</script>

<!-- Add Universal Comment Widget - Expert can click anywhere to add feedback -->
<script>
window.commentWidgetConfig = {
    apiBase: "https://clamshell-backend-qbeqioz7a-mohammed-asrafs-projects.vercel.app",
    position: "top-right"
};
</script>
<script src="./comment-widget-hybrid.js"></script>

<script>
function showBackendError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.id = 'backend-error-overlay';
    errorDiv.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
    errorDiv.innerHTML = `
        <div class="bg-red-900 text-white p-8 rounded-lg max-w-2xl">
            <h2 class="text-2xl font-bold mb-4">⚠️ AI Backend Required</h2>
            <p class="mb-4">${message}</p>
            <p class="text-sm opacity-80">Backend must be running at https://clamshell-backend-qbeqioz7a-mohammed-asrafs-projects.vercel.app</p>
            <button onclick="location.reload()" class="mt-4 bg-white text-red-900 px-6 py-2 rounded font-bold">Retry</button>
        </div>
    `;
    document.body.appendChild(errorDiv);
}
</script>

</body>
</html>