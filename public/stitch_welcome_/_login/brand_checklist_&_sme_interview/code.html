<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Space+Grotesk:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>CourseCraft AI - SME Interview Panel</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
    :root {
      --primary-color: #3713ec;
      --red-glow: #ff4d4d;
      --blue-glow: #4d94ff;
      --white-glow: #ffffff;
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --ai-purple: #8b5cf6;
      --ai-teal: #14b8a6;
      --gradient-primary: linear-gradient(135deg, var(--ai-purple) 0%, var(--blue-glow) 100%);
    }
    
    /* SME Interview Styling */
    .sme-panel {
        background: linear-gradient(135deg, #1a1823 0%, #2b2839 100%);
        border: 2px solid rgba(139, 92, 246, 0.4);
        border-radius: 24px;
        padding: 32px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
    }
    
    .sme-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--ai-purple), var(--blue-glow), var(--ai-teal));
    }
    
    .sme-question-card {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(20, 184, 166, 0.1) 100%);
        border: 2px solid rgba(139, 92, 246, 0.3);
        border-radius: 20px;
        padding: 24px;
        margin: 16px 0;
        transition: all 0.4s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .sme-question-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(139, 92, 246, 0.3);
        border-color: var(--ai-purple);
    }
    
    .sme-question-card.answered {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(22, 163, 74, 0.1) 100%);
        border-color: rgba(34, 197, 94, 0.4);
    }
    
    .sme-answer-textarea {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        padding: 16px;
        color: white;
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
        transition: all 0.3s ease;
    }
    
    .sme-answer-textarea:focus {
        outline: none;
        border-color: var(--ai-purple);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }
    
    .sme-progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .sme-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--ai-purple), var(--ai-teal));
        transition: width 0.5s ease;
    }
    
    .sme-badge {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .sme-generating {
        background: linear-gradient(45deg, #f59e0b, #f97316);
        animation: pulse 2s infinite;
    }
    
    .sme-ready {
        background: linear-gradient(45deg, #22c55e, #16a34a);
    }
    
    .sme-complete {
        background: linear-gradient(45deg, #3b82f6, #2563eb);
    }
    
    @keyframes pulse {
        0%, 100% { 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            transform: scale(1);
        }
        50% { 
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
            transform: scale(1.02);
        }
    }
    
    .btn-sme {
        background: linear-gradient(135deg, var(--ai-purple), var(--blue-glow));
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 16px 32px;
        font-weight: 700;
        font-size: 1.1rem;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-sme:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(139, 92, 246, 0.5);
        border-color: rgba(255, 255, 255, 0.4);
    }
    
    .btn-sme:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .sme-spinner {
        width: 20px;
        height: 20px;
        border: 3px solid transparent;
        border-top: 3px solid currentColor;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        display: inline-block;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .question-type-badge {
        font-size: 0.75rem;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .type-challenges { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .type-scenarios { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .type-assessment { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .type-safety { background: rgba(220, 38, 38, 0.2); color: #dc2626; }
    .type-practical { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .type-objectives { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .type-general { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .type-ai_content_specific { background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(139, 92, 246, 0.3)); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); }
</style>
</head>
<body>
<div class="relative flex size-full min-h-screen flex-col bg-[#121118] overflow-hidden" style='font-family: "Space Grotesk", "Noto Sans", sans-serif;'>

<!-- Enhanced Animated Background -->
<div class="absolute inset-0 opacity-25">
<div class="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-xl animate-pulse"></div>
<div class="absolute top-3/4 right-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-1000"></div>
<div class="absolute bottom-1/4 left-1/3 w-96 h-96 bg-teal-600 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-2000"></div>
</div>

<div class="relative z-10 layout-container flex h-full grow flex-col">

<!-- SME Header -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#2b2839]/70 px-10 py-6 backdrop-blur-md">
<div class="flex items-center gap-6 text-white">
<div class="size-10 text-[var(--ai-purple)]">
<svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M24 4C12.95 4 4 12.95 4 24s8.95 20 20 20 20-8.95 20-20S35.05 4 24 4zm-2 32l-8-8 2.83-2.83L22 30.34l9.17-9.17L34 24 22 36z"/>
</svg>
</div>
<div>
<h1 class="text-white text-2xl font-bold leading-tight tracking-[-0.015em]">CourseCraft AI</h1>
<p class="text-gray-400 text-sm">SME Interview Panel ‚Ä¢ Dr. Elena Rodriguez</p>
</div>
<div id="sme-status" class="sme-badge sme-generating">
<div class="sme-spinner"></div>
<span>Generating Questions...</span>
</div>
</div>
<nav class="flex items-center gap-8 text-sm font-medium text-gray-300">
<a class="hover:text-white transition-colors flex items-center gap-2" href="#" onclick="goBackToAnalysis()">
<span class="material-symbols-outlined text-lg">arrow_back</span>
Back to Analysis
</a>
<a class="hover:text-white transition-colors flex items-center gap-2" href="#" onclick="viewProgress()">
<span class="material-symbols-outlined text-lg">insights</span>
Progress
</a>
</nav>
</header>

<!-- Main SME Panel -->
<main class="flex flex-1 justify-center py-12 px-6">
<div class="w-full max-w-5xl">

<!-- SME Title Section -->
<div class="text-center mb-12">
<h2 class="text-white tracking-tight text-5xl font-bold leading-tight mb-4">
üß† Expert SME Interview
</h2>
<p class="text-gray-400 text-xl leading-relaxed max-w-4xl mx-auto">
Dr. Elena Rodriguez ‚Ä¢ Instructional Designer ‚Ä¢ Content Strategy Analysis
</p>
<p id="sme-content-summary" class="text-gray-500 text-lg mt-4 max-w-3xl mx-auto">
Generating expert questions for your content strategy analysis...
</p>
</div>

<!-- SME Interview Progress -->
<div id="sme-progress-section" class="hidden mb-8">
<div class="sme-panel">
<div class="flex items-center justify-between mb-6">
<h3 class="text-white text-2xl font-bold">Expert Interview Progress</h3>
<div class="flex items-center gap-4 text-base">
<span class="text-gray-300">Completed:</span>
<span id="sme-progress-text" class="text-white font-bold">0 / 0</span>
</div>
</div>
<div class="sme-progress-bar">
<div id="sme-progress-fill" class="sme-progress-fill" style="width: 0%"></div>
</div>
<div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-400">
<div>üìä Content Domain: <span id="sme-domain" class="text-white font-semibold">--</span></div>
<div>‚è±Ô∏è Est. Time: <span id="sme-estimated-time" class="text-white font-semibold">--</span></div>
<div>üéØ Purpose: <span class="text-white font-semibold">E-Learning Strategy Recommendations</span></div>
</div>
</div>
</div>

<!-- SME Questions Container -->
<div id="sme-questions-container" class="hidden space-y-6">
<div class="sme-panel mb-8">
<h3 class="text-white text-3xl font-bold mb-4 flex items-center gap-3">
<span class="material-symbols-outlined text-purple-400">psychology</span>
Expert Strategy Interview
</h3>
<p class="text-gray-300 text-lg mb-6">
Answer these questions to help Dr. Elena recommend the most suitable e-learning strategies for your content.
</p>
<div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-6 mb-8">
<h4 class="text-purple-300 font-semibold mb-3 flex items-center gap-2">
<span class="material-symbols-outlined">info</span>
Expert Interview Guidelines
</h4>
<ul class="text-purple-100 space-y-2 text-sm">
<li class="flex items-start gap-2">
<span class="material-symbols-outlined text-xs mt-1">check</span>
<span>Provide detailed answers based on your content expertise</span>
</li>
<li class="flex items-start gap-2">
<span class="material-symbols-outlined text-xs mt-1">check</span>
<span>Include learning objectives and target audience details</span>
</li>
<li class="flex items-start gap-2">
<span class="material-symbols-outlined text-xs mt-1">check</span>
<span>Share real-world challenges and application scenarios</span>
</li>
<li class="flex items-start gap-2">
<span class="material-symbols-outlined text-xs mt-1">check</span>
<span>Your answers will help determine optimal e-learning strategies</span>
</li>
</ul>
</div>
</div>

<!-- Questions will be dynamically inserted here -->
<div id="sme-questions-list"></div>
</div>

<!-- SME Completion Section -->
<div id="sme-completion-section" class="hidden text-center">
<div class="sme-panel">
<div class="flex flex-col items-center gap-8">
<div class="w-32 h-32 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center border-4 border-white/20">
<span class="material-symbols-outlined text-6xl text-white">psychology</span>
</div>
<div>
<h3 class="text-white text-4xl font-bold mb-4">Expert Interview Complete!</h3>
<p class="text-gray-300 text-xl max-w-2xl">
Thank you for providing valuable insights. Dr. Elena will now analyze your content and answers to recommend optimal e-learning strategies.
</p>
</div>
<div class="grid grid-cols-3 gap-8 w-full max-w-2xl text-center">
<div class="bg-purple-900/40 border border-purple-500/30 rounded-xl p-6">
<div id="completed-questions" class="text-3xl font-bold text-purple-400 mb-2">0</div>
<div class="text-gray-300">Questions Answered</div>
</div>
<div class="bg-blue-900/40 border border-blue-500/30 rounded-xl p-6">
<div id="total-insights" class="text-3xl font-bold text-blue-400 mb-2">0</div>
<div class="text-gray-300">Expert Insights</div>
</div>
<div class="bg-green-900/40 border border-green-500/30 rounded-xl p-6">
<div class="text-3xl font-bold text-green-400 mb-2">‚úì</div>
<div class="text-gray-300">Ready for Strategy Analysis</div>
</div>
</div>
<button id="proceed-to-strategy-recommendations" class="btn-sme text-xl px-12 py-6" onclick="proceedToReportGeneration()">
<span class="material-symbols-outlined mr-3">lightbulb</span>
Generate Comprehensive Report
</button>
</div>
</div>
</div>

<!-- SME Submit Button (Fixed Position) -->
<div id="sme-submit-section" class="hidden fixed bottom-8 right-8 z-50">
<button id="sme-submit-btn" class="btn-sme disabled:opacity-50" onclick="submitSMEAnswers()" disabled>
<span id="sme-submit-text">Submit Expert Interview</span>
<span class="material-symbols-outlined ml-3">send</span>
</button>
</div>

</div>
</main>
</div>

<script>
// ===================================
// SME SYSTEM WITH STRATEGY RECOMMENDATIONS
// ===================================

const BACKEND_URL = 'https://clamshell-backend-m4sbwxqlw-mohammed-asrafs-projects.vercel.app'; // Backend integration enabled

// SME global state
let currentSMESession = null;
let smeQuestions = [];
let smeAnswers = {};
let originalAnalysisSession = null;

// Generate dynamic SME questions based on content domain
// NOTE: These questions focus on implementation details, realistic duration/scheduling, assessments, and domain-specific concerns
// Pre-SME covers general planning: basic duration, learning objectives, target audience, prerequisites
function generateDynamicSMEQuestions(domain) {
    const questionTemplates = {
        'Healthcare & Medical': [
            { question: 'What specific patient safety protocols must be emphasized in this training?' },
            { question: 'How much time should clinical staff realistically spend on this training during their shift patterns?' },
            { question: 'How do you currently measure clinical competency for this content area?' },
            { question: 'What are the most common medical errors related to this topic?' },
            { question: 'How does this content integrate with your existing clinical workflows?' },
            { question: 'What regulatory compliance requirements must be addressed?' },
            { question: 'Should this training be delivered in short bursts between patient care or as dedicated training blocks?' }
        ],
        'Technology & IT': [
            { question: 'What development tools and environments will learners use?' },
            { question: 'How much focused development time should be allocated for hands-on practice with this technology?' },
            { question: 'How do you measure coding proficiency and best practices?' },
            { question: 'What are the most common technical challenges in this area?' },
            { question: 'How does this content fit into your technology stack?' },
            { question: 'What security considerations must be emphasized?' },
            { question: 'Should coding sessions be intensive workshops or distributed learning over several weeks?' },
            { question: 'What real-world coding scenarios should be included for hands-on practice?' }
        ],
        'Business & Management': [
            { question: 'What are the primary business objectives for this training?' },
            { question: 'How will you measure the success of this training program?' },
            { question: 'What challenges do learners currently face in this area?' },
            { question: 'How does this training support organizational strategic goals?' },
            { question: 'What tools and resources are available for implementation?' }
        ],
        'Personal/Administrative': [
            { question: 'What organizational context would make this content relevant?' },
            { question: 'How could this content be adapted for professional use?' },
            { question: 'What specific business applications are you considering?' }
        ]
    };

    return questionTemplates[domain] || questionTemplates['Business & Management'];
}

// Initialize SME system
document.addEventListener('DOMContentLoaded', function() {
    console.log('üß† SME Interview System Starting...');
    console.log('üë©‚Äçüè´ Expert: Dr. Elena Rodriguez - Instructional Designer');
    console.log('üéØ Purpose: E-Learning Strategy Recommendations');
    
    // Enhanced session detection
    originalAnalysisSession = getOriginalAnalysisSession();
    
    console.log('üîç Session Detection Results:');
    console.log('   üìä Found Session:', !!originalAnalysisSession);
    console.log('   üìù Session ID:', originalAnalysisSession?.sessionId || 'Not found');
    console.log('   üìÑ Has Data:', !!originalAnalysisSession?.data);
    
    if (originalAnalysisSession) {
        startSMEInterviewProcess();
    } else {
        console.error('‚ùå No analysis session found');
        showDetailedError();
    }
});

// Get original analysis session
function getOriginalAnalysisSession() {
    console.log('üîç Searching for analysis session data...');
    
    try {
        // Method 1: Check localStorage
        const stored = localStorage.getItem('expertAnalysisResults');
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                console.log('‚úÖ Found in localStorage:', parsed.sessionId);
                if (parsed.sessionId && (parsed.data || parsed.domainClassification)) {
                    return parsed;
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è localStorage data corrupted:', e);
            }
        }
        
        // Method 2: Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');
        if (sessionId) {
            console.log('‚úÖ Found session ID in URL:', sessionId);
            return { sessionId: sessionId };
        }
        
        // Method 3: Check session markers
        const currentSessionId = localStorage.getItem('currentSessionId');
        const analysisComplete = localStorage.getItem('analysisComplete');
        
        if (currentSessionId && analysisComplete === 'true') {
            console.log('‚úÖ Found session markers:', currentSessionId);
            return { sessionId: currentSessionId };
        }
        
        console.log('‚ùå No analysis session found');
        return null;
        
    } catch (error) {
        console.error('‚ùå Error during session detection:', error);
        return null;
    }
}

// Start SME interview process
async function startSMEInterviewProcess() {
    console.log('üöÄ Starting intelligent expert strategy interview process...');

    try {
        updateSMEStatus('Dr. Elena Analyzing Content...', 'sme-generating');

        // Get analysis data
        const analysisData = originalAnalysisSession.data || originalAnalysisSession;
        const sessionId = originalAnalysisSession.sessionId;

        console.log('üß† Requesting AI-generated content-specific questions from Dr. Elena...');
        console.log('   üìä Domain:', analysisData.domainClassification?.primaryDomain);
        console.log('   üìà Complexity:', analysisData.domainClassification?.complexity);
        console.log('   üéØ Quality Score:', analysisData.qualityAssessment?.overallScore);

        const contentDomain = analysisData.domainClassification?.primaryDomain || 'General';

        // Get AI-generated SME questions from analysis data (already generated by /api/analyze)
        let intelligentQuestions;
        try {
            console.log('ü§ñ Using AI-powered SME questions from analysis...');

            // Questions are already generated in the analyze endpoint and stored in analysisData
            const questions = analysisData.smeQuestions || analysisData.contentSpecificSMEQuestions;

            if (questions && questions.length > 0) {
                console.log('‚úÖ Dr. Elena loaded AI-powered content-specific questions:', questions.length);

                // Handle both string questions and structured question objects from AI
                intelligentQuestions = questions.map((q, index) => {
                    if (typeof q === 'string') {
                        // Simple string question
                        return {
                            question: q,
                            purpose: "AI-generated content-specific question for optimal strategy selection",
                            type: "ai_content_specific",
                            contentFocus: "Content Analysis",
                            priority: index < 3 ? 'High' : index < 6 ? 'Medium' : 'Low'
                        };
                    } else {
                        // Structured question object from AI
                        return {
                            question: q.question || q,
                            purpose: q.purpose || "AI-generated content-specific question for optimal strategy selection",
                            type: "ai_content_specific",
                            contentFocus: q.contentFocus || "Content Analysis",
                            priority: q.priority || (index < 3 ? 'High' : index < 6 ? 'Medium' : 'Low'),
                            strategyRelevance: q.strategyRelevance || null
                        };
                    }
                });

                console.log('üìã Processed AI questions:', intelligentQuestions.length, 'questions ready');
            } else {
                throw new Error('No SME questions found in analysis data');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è AI questions not available, falling back to enhanced offline generation:', error);
            console.log('üß† Generating enhanced content-specific questions offline...');
            intelligentQuestions = generateIntelligentQuestions(analysisData);
        }

        const questionData = {
            sessionId: 'sme_intelligent_' + Date.now(),
            contentDomain: contentDomain,
            questionCount: intelligentQuestions.length,
            questions: intelligentQuestions,
            success: true
        };

        console.log('‚úÖ Dr. Elena generated content-specific questions:', questionData.questionCount);
        console.log('   üéØ Content Domain:', questionData.contentDomain);

        // Store SME session data
        currentSMESession = {
            smeSessionId: questionData.sessionId,
            contentDomain: questionData.contentDomain,
            questionCount: questionData.questionCount,
            estimatedInterviewTime: '15-20 minutes',
            questions: questionData.questions
        };
        smeQuestions = questionData.questions;

        // Prepare display data
        const displayData = {
            questionCount: questionData.questionCount,
            contentDomain: questionData.contentDomain,
            estimatedInterviewTime: '15-20 minutes',
            questions: questionData.questions
        };

        // Update UI with intelligent questions
        displaySMEQuestions(displayData);

        // Update status based on question source
        if (intelligentQuestions.some(q => q.type === 'ai_content_specific')) {
            updateSMEStatus('ü§ñ AI-Generated Content-Specific Questions Ready', 'sme-ready');
            console.log('üéØ Using AI-powered content-specific questions from backend');
        } else {
            updateSMEStatus('Dr. Elena\'s Enhanced Questions Ready', 'sme-ready');
            console.log('üìã Using enhanced offline-generated questions');
        }

    } catch (error) {
        console.error('‚ùå Intelligent SME interview initialization failed:', error);
        updateSMEStatus('Error - Using Fallback Questions', 'sme-generating');

        // Use content-specific questions from analysis
        console.log('‚ö†Ô∏è Using content-specific questions from analysis...');

        const contentDomain = originalAnalysisSession.data?.domainClassification?.primaryDomain || 'General';

        // Get content-specific SME questions from analysis data
        const contentSpecificQuestions = originalAnalysisSession.data?.contentSpecificSMEQuestions ||
            generateDynamicSMEQuestions(contentDomain);

        const fallbackData = {
            questionCount: contentSpecificQuestions.length,
            contentDomain: contentDomain,
            estimatedInterviewTime: '10-15 minutes',
            questions: contentSpecificQuestions.map((q, index) => ({
                id: index + 1,
                question: q.question || q,
                type: 'content_specific',
                priority: 'high',
                contentFocus: contentDomain,
                expectedWordCount: '50-150'
            }))
        };

        currentSMESession = {
            smeSessionId: 'sme_fallback_' + Date.now(),
            ...fallbackData
        };
        smeQuestions = fallbackData.questions;

        displaySMEQuestions(fallbackData);
        updateSMEStatus('Expert Questions Ready (Fallback)', 'sme-ready');

        // Show warning to user
        setTimeout(() => {
            console.warn('Using fallback questions - backend integration unavailable');
        }, 2000);
    }
}

// Generate intelligent content-specific questions
function generateIntelligentQuestions(analysisData) {
    console.log('üß† Generating intelligent content-specific questions...');

    const domain = analysisData.domainClassification?.primaryDomain || 'General';
    const complexity = analysisData.domainClassification?.complexity || 'Medium';
    const qualityScore = analysisData.qualityAssessment?.overallScore || 75;

    // Get base questions
    const baseQuestions = generateExpertStrategyQuestions(domain);

    // Add intelligent domain-specific questions
    const intelligentQuestions = getIntelligentDomainQuestions(domain, complexity, qualityScore);

    // Combine and prioritize
    const allQuestions = [...baseQuestions, ...intelligentQuestions];

    // Add priorities and strategy relevance
    return allQuestions.map((q, index) => ({
        ...q,
        priority: index < 3 ? 'High' : index < 6 ? 'Medium' : 'Low',
        strategyRelevance: getStrategyRelevance(q.type, domain)
    }));
}

// Get intelligent domain-specific questions
function getIntelligentDomainQuestions(domain, complexity, qualityScore) {
    const domainQuestions = {
        'Technical Training': [
            {
                question: "What specific technical prerequisites or foundational knowledge do learners need before starting this training?",
                purpose: "To design proper learning pathways and prerequisite assessments",
                type: "prerequisites_analysis",
                contentFocus: "Learning Prerequisites"
            },
            {
                question: "What are the most critical safety protocols learners must master, and how can we simulate high-risk scenarios safely?",
                purpose: "To create immersive safety training without real-world risks",
                type: "safety_simulation",
                contentFocus: "Safety Training"
            }
        ],
        'Business Training': [
            {
                question: "What business metrics or KPIs will demonstrate that learners have successfully applied this training in their roles?",
                purpose: "To create measurable learning outcomes tied to business results",
                type: "business_metrics",
                contentFocus: "ROI Measurement"
            },
            {
                question: "How can we create realistic business scenarios that challenge learners to apply multiple concepts simultaneously?",
                purpose: "To design complex problem-solving exercises that mirror real work",
                type: "complex_scenarios",
                contentFocus: "Real-world Application"
            }
        ],
        'Healthcare Training': [
            {
                question: "What patient safety considerations require the highest level of competency validation before allowing real-world practice?",
                purpose: "To identify critical competencies requiring certification-level assessment",
                type: "competency_validation",
                contentFocus: "Patient Safety"
            },
            {
                question: "How can we simulate rare but critical medical situations to prepare learners for emergency decision-making?",
                purpose: "To create high-stakes scenario training for rare but important cases",
                type: "emergency_simulation",
                contentFocus: "Crisis Preparedness"
            }
        ]
    };

    return domainQuestions[domain] || [
        {
            question: "What innovative technologies or methods could enhance the learning experience for this specific content?",
            purpose: "To explore cutting-edge learning technologies for optimal engagement",
            type: "technology_enhancement",
            contentFocus: "Innovation Integration"
        }
    ];
}

// Get strategy relevance for question type
function getStrategyRelevance(questionType, domain) {
    const relevanceMap = {
        'learning_objectives': 'Critical for determining instructional design approach and assessment strategy',
        'audience_analysis': 'Essential for personalizing learning paths and difficulty levels',
        'challenges_identification': 'Key for proactive learning obstacle prevention and support design',
        'scenario_development': 'Vital for creating authentic learning contexts and practical applications',
        'assessment_strategy': 'Fundamental for measuring learning effectiveness and certification requirements',
        'practical_exercises': 'Important for skill development and knowledge retention through practice',
        'prerequisites_analysis': 'Crucial for ensuring learner readiness and proper sequencing',
        'safety_simulation': 'Critical for risk-free practice of potentially dangerous procedures',
        'business_metrics': 'Essential for demonstrating training ROI and business impact',
        'competency_validation': 'Vital for ensuring safe practice in high-stakes environments'
    };

    return relevanceMap[questionType] || 'Important for comprehensive learning strategy development';
}

// Generate expert strategy questions based on content domain
function generateExpertStrategyQuestions(contentDomain) {
    const baseQuestions = [
        {
            question: "What are the specific learning objectives you want learners to achieve with this content?",
            purpose: "To identify clear, measurable learning outcomes for strategy selection",
            type: "learning_objectives",
            contentFocus: "Learning Goals"
        },
        {
            question: "Who is your target audience and what is their current knowledge level on this topic?",
            purpose: "To determine appropriate instructional strategies and complexity level",
            type: "audience_analysis", 
            contentFocus: "Learner Profile"
        },
        {
            question: "What are the most common challenges or misconceptions learners face with this content?",
            purpose: "To identify potential learning obstacles and design preventive strategies",
            type: "challenges_identification",
            contentFocus: "Learning Barriers"
        },
        {
            question: "Can you describe a real-world scenario where learners would apply this knowledge or skill?",
            purpose: "To create authentic learning contexts and practical examples",
            type: "scenario_development",
            contentFocus: "Practical Application"
        },
        {
            question: "How would you assess if someone has truly mastered this content?",
            purpose: "To design effective assessment strategies and success criteria",
            type: "assessment_strategy",
            contentFocus: "Knowledge Evaluation"
        },
        {
            question: "What hands-on activities or practice exercises would help learners develop this skill?",
            purpose: "To create engaging interactive learning experiences",
            type: "practical_exercises", 
            contentFocus: "Skill Development"
        }
    ];

    // Add domain-specific questions based on content type
    const domainSpecificQuestions = getDomainSpecificQuestions(contentDomain);
    
    return [...baseQuestions, ...domainSpecificQuestions];
}

// Get domain-specific questions
function getDomainSpecificQuestions(domain) {
    const domainQuestions = {
        'Technical Training': [
            {
                question: "What safety protocols or precautions must learners follow when applying this technical knowledge?",
                purpose: "To ensure safe and responsible application of technical skills",
                type: "safety_protocols",
                contentFocus: "Safety & Compliance"
            },
            {
                question: "What tools, equipment, or software will learners need to practice these skills?",
                purpose: "To determine resource requirements for hands-on learning",
                type: "resource_requirements",
                contentFocus: "Learning Resources"
            }
        ],
        'Business Training': [
            {
                question: "How does this knowledge impact business outcomes or organizational goals?",
                purpose: "To connect learning to business value and ROI",
                type: "business_impact",
                contentFocus: "Business Value"
            },
            {
                question: "What are the key performance indicators that would show successful application of this knowledge?",
                purpose: "To establish measurable business outcomes",
                type: "performance_metrics",
                contentFocus: "Success Metrics"
            }
        ],
        'Healthcare Training': [
            {
                question: "What patient safety considerations are critical when applying this knowledge?",
                purpose: "To ensure patient safety and clinical best practices",
                type: "patient_safety",
                contentFocus: "Patient Safety"
            },
            {
                question: "How would you handle emergency situations or complications related to this procedure/knowledge?",
                purpose: "To prepare learners for critical decision-making",
                type: "emergency_protocols",
                contentFocus: "Crisis Management"
            }
        ]
    };

    return domainQuestions[domain] || [
        {
            question: "What additional resources or support would help learners succeed with this content?",
            purpose: "To identify supplementary learning materials and support needs",
            type: "support_resources",
            contentFocus: "Learning Support"
        }
    ];
}

// Update SME status
function updateSMEStatus(text, className) {
    const statusEl = document.getElementById('sme-status');
    if (!statusEl) return;
    
    statusEl.className = `sme-badge ${className}`;
    
    const icon = className === 'sme-generating' ? '<div class="sme-spinner"></div>' :
                 className === 'sme-ready' ? '<span class="material-symbols-outlined">psychology</span>' :
                 '<span class="material-symbols-outlined">check_circle</span>';
    
    statusEl.innerHTML = `${icon}<span>${text}</span>`;
}

// Display SME questions
function displaySMEQuestions(data) {
    console.log('üìã Displaying expert strategy questions...');
    
    if (!data || !data.questions || data.questions.length === 0) {
        showError('No expert questions available');
        return;
    }
    
    try {
        // Update content summary
        document.getElementById('sme-content-summary').textContent = 
            `${data.questionCount} expert strategy questions for ${data.contentDomain} content ‚Ä¢ Est. time: ${data.estimatedInterviewTime}`;
        
        // Update progress section
        const progressSection = document.getElementById('sme-progress-section');
        document.getElementById('sme-domain').textContent = data.contentDomain;
        document.getElementById('sme-estimated-time').textContent = data.estimatedInterviewTime;
        document.getElementById('sme-progress-text').textContent = `0 / ${data.questionCount}`;
        progressSection.classList.remove('hidden');
        
        // Display questions
        const questionsContainer = document.getElementById('sme-questions-container');
        const questionsList = document.getElementById('sme-questions-list');
        
        questionsList.innerHTML = '';
        
        data.questions.forEach((question, index) => {
            const questionCard = createSMEQuestionCard(question, index);
            questionsList.appendChild(questionCard);
        });
        
        questionsContainer.classList.remove('hidden');
        document.getElementById('sme-submit-section').classList.remove('hidden');
        
        console.log(`‚úÖ Displayed ${data.questions.length} expert strategy questions`);
    } catch (error) {
        console.error('‚ùå Error displaying expert questions:', error);
        showError('Error displaying expert questions: ' + error.message);
    }
}

// Create SME question card
function createSMEQuestionCard(question, index) {
    const card = document.createElement('div');
    card.className = 'sme-question-card';
    card.id = `question-${index + 1}`;

    const typeClass = getQuestionTypeClass(question.type);
    const priorityIcon = question.priority === 'High' ? 'üî•' : question.priority === 'Medium' ? '‚ö°' : 'üìã';
    const priorityColor = question.priority === 'High' ? 'text-red-400' : question.priority === 'Medium' ? 'text-yellow-400' : 'text-blue-400';

    card.innerHTML = `
        <div class="flex items-start gap-4 mb-6">
            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white font-bold text-lg border-2 border-white/20">
                ${index + 1}
            </div>
            <div class="flex-1">
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <span class="question-type-badge ${typeClass}">
                        ${question.type === 'ai_content_specific' ? 'ü§ñ AI Content-Specific' : question.type.replace(/_/g, ' ')}
                    </span>
                    <span class="text-gray-400 text-sm">‚Ä¢ ${question.contentFocus || 'Strategy Focus'}</span>
                    <span class="text-xs px-2 py-1 rounded-full border ${priorityColor} border-current">
                        ${priorityIcon} ${question.priority || 'Medium'} Priority
                    </span>
                    ${question.type === 'ai_content_specific' ? '<span class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30">‚ú® GPT-4o-mini Generated</span>' : ''}
                </div>
                <h4 class="text-white text-xl font-bold mb-3 leading-relaxed">${question.question}</h4>
                <p class="text-gray-300 text-base mb-2"><strong>Expert Purpose:</strong> ${question.purpose}</p>
                ${question.strategyRelevance ? `<p class="text-purple-200 text-sm mb-4"><strong>üéØ Strategy Relevance:</strong> ${question.strategyRelevance}</p>` : ''}
            </div>
        </div>

        <div class="space-y-4">
            <label class="text-gray-300 font-semibold text-base">Your Expert Response:</label>
            <textarea
                id="answer-${index + 1}"
                class="sme-answer-textarea w-full"
                placeholder="Provide detailed insights based on your content expertise. Include specific examples, learning objectives, and practical considerations..."
                oninput="updateAnswerProgress(${index + 1})"
                onfocus="highlightQuestion(${index + 1})"
                onblur="unhighlightQuestion(${index + 1})"
            ></textarea>
            <div class="flex items-center justify-between text-sm">
                <div class="flex items-center gap-4 text-gray-400">
                    <span id="char-count-${index + 1}">0 characters</span>
                    <span id="word-count-${index + 1}">0 words</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-gray-400">psychology</span>
                    <span class="text-gray-400">Dr. Elena uses your responses to recommend expert strategies</span>
                </div>
            </div>
        </div>
    `;

    return card;
}

// Get question type CSS class
function getQuestionTypeClass(type) {
    const typeMap = {
        'learning_objectives': 'type-objectives',
        'audience_analysis': 'type-assessment',
        'challenges_identification': 'type-challenges',
        'scenario_development': 'type-scenarios', 
        'assessment_strategy': 'type-assessment',
        'practical_exercises': 'type-practical',
        'safety_protocols': 'type-safety',
        'business_impact': 'type-assessment',
        'patient_safety': 'type-safety'
    };
    
    return typeMap[type] || 'type-general';
}

// Update answer progress
function updateAnswerProgress(questionId) {
    const textarea = document.getElementById(`answer-${questionId}`);
    const charCount = document.getElementById(`char-count-${questionId}`);
    const wordCount = document.getElementById(`word-count-${questionId}`);
    
    if (!textarea || !charCount || !wordCount) return;
    
    const text = textarea.value;
    const chars = text.length;
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    
    charCount.textContent = `${chars} characters`;
    wordCount.textContent = `${words} words`;
    
    // Store answer
    smeAnswers[questionId] = {
        questionId: questionId,
        question: smeQuestions[questionId - 1]?.question || '',
        answer: text,
        type: smeQuestions[questionId - 1]?.type || 'general',
        contentFocus: smeQuestions[questionId - 1]?.contentFocus || '',
        wordCount: words,
        charCount: chars
    };
    
    // Update question card styling
    const questionCard = document.getElementById(`question-${questionId}`);
    if (questionCard) {
        if (text.trim().length > 20) {
            questionCard.classList.add('answered');
        } else {
            questionCard.classList.remove('answered');
        }
    }
    
    // Update overall progress
    updateOverallProgress();
}

// Update overall progress
function updateOverallProgress() {
    const totalQuestions = smeQuestions.length;
    const answeredQuestions = Object.values(smeAnswers).filter(a => 
        a.answer && a.answer.trim().length > 20
    ).length;
    
    const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
    
    // Update progress bar
    const progressFill = document.getElementById('sme-progress-fill');
    const progressText = document.getElementById('sme-progress-text');
    
    if (progressFill) progressFill.style.width = `${progress}%`;
    if (progressText) progressText.textContent = `${answeredQuestions} / ${totalQuestions}`;
    
    // Update submit button
    const submitBtn = document.getElementById('sme-submit-btn');
    if (submitBtn) {
        if (answeredQuestions >= Math.ceil(totalQuestions * 0.6)) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
        }
    }
    
    // Check if interview is complete
    if (answeredQuestions === totalQuestions) {
        updateSMEStatus('Expert Interview Complete', 'sme-complete');
    } else if (answeredQuestions > 0) {
        updateSMEStatus(`${answeredQuestions}/${totalQuestions} Answered`, 'sme-generating');
    }
}

// Highlight question
function highlightQuestion(questionId) {
    const questionCard = document.getElementById(`question-${questionId}`);
    if (questionCard) {
        questionCard.style.transform = 'translateY(-4px)';
        questionCard.style.boxShadow = '0 15px 40px rgba(139, 92, 246, 0.4)';
    }
}

// Unhighlight question
function unhighlightQuestion(questionId) {
    const questionCard = document.getElementById(`question-${questionId}`);
    if (questionCard && !questionCard.classList.contains('answered')) {
        questionCard.style.transform = '';
        questionCard.style.boxShadow = '';
    }
}

// Submit SME answers
async function submitSMEAnswers() {
    console.log('üì§ Submitting expert strategy interview answers to backend...');

    if (!currentSMESession) {
        showError('No active expert session found');
        return;
    }

    const submitBtn = document.getElementById('sme-submit-btn');
    const submitText = document.getElementById('sme-submit-text');

    // Disable submit button and show loading
    submitBtn.disabled = true;
    submitText.innerHTML = '<div class="sme-spinner mr-3"></div>Dr. Elena Processing Insights...';

    try {
        // Prepare answers data
        const answersArray = Object.values(smeAnswers).filter(a =>
            a.answer && a.answer.trim().length > 0
        );

        console.log('üìä Submitting Expert Strategy Data:', {
            sessionId: currentSMESession.smeSessionId,
            answerCount: answersArray.length,
            contentDomain: currentSMESession.contentDomain
        });

        // Store SME responses using backend
        console.log('üíæ Storing SME responses to backend...');

        // Update status
        submitText.innerHTML = '<div class="sme-spinner mr-3"></div>Dr. Elena Storing Expert Responses...';

        try {
            const storeResponse = await fetch(`${BACKEND_URL}/sme/submit-sme-answers`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    smeSessionId: currentSMESession.smeSessionId,
                    answers: answersArray.map(answer => ({
                        questionId: answer.questionId,
                        question: answer.question,
                        answer: answer.answer,
                        type: answer.type,
                        contentFocus: answer.contentFocus
                    })),
                    metadata: {
                        completedAt: new Date().toISOString(),
                        totalQuestions: answersArray.length,
                        originalSessionId: originalAnalysisSession?.sessionId
                    }
                })
            });

            if (storeResponse.ok) {
                const storeResult = await storeResponse.json();
                console.log('‚úÖ SME responses stored successfully:', storeResult);
            } else {
                console.warn('‚ö†Ô∏è Backend storage failed, continuing with local storage');
            }
        } catch (storeError) {
            console.warn('‚ö†Ô∏è Backend storage error, continuing with local storage:', storeError);
        }

        // Update status
        submitText.innerHTML = '<div class="sme-spinner mr-3"></div>Dr. Elena Analyzing Responses...';

        // Brief processing delay
        await new Promise(resolve => setTimeout(resolve, 800));

        // Generate AI-powered strategy recommendations from backend
        submitText.innerHTML = '<div class="sme-spinner mr-3"></div>Dr. Elena Generating Personalized Strategy Recommendations...';

        let strategyRecommendations;

        try {
            // Get all required data for strategy generation
            const professionalAnalysisData = localStorage.getItem('professionalAnalysisResults');
            const preSMEData = localStorage.getItem('preSMEAnswers');
            const domainClassificationData = localStorage.getItem('domainClassificationResults');
            const courseId = localStorage.getItem('courseId') || 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            if (!localStorage.getItem('courseId')) {
                localStorage.setItem('courseId', courseId);
            }

            const analysisData = professionalAnalysisData ? JSON.parse(professionalAnalysisData) : {};
            const preSME = preSMEData ? JSON.parse(preSMEData) : {};
            const domainData = domainClassificationData ? JSON.parse(domainClassificationData) : {};
            const domain = domainData.domain || domainData.data?.domain || analysisData.data?.domain || currentSMESession.contentDomain || 'General';

            console.log('üéØ Calling backend AI for strategy generation...');
            console.log('üìã Domain:', domain);
            console.log('üìö Course ID:', courseId);
            console.log('üí¨ SME Answers:', answersArray.length);

            // Call backend API for AI-generated strategies
            const response = await fetch(`${BACKEND_URL}/api/generate-strategies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: analysisData.data?.content || '',
                    analysisData: analysisData.data || analysisData.analysis || {},
                    preSMEAnswers: preSME,
                    smeAnswers: answersArray,
                    domain: domain,
                    courseId: courseId
                })
            });

            if (response.ok) {
                const result = await response.json();
                strategyRecommendations = result.strategies;
                console.log('‚úÖ AI-powered strategies generated from backend');
                console.log('   üéØ Strategies:', strategyRecommendations.strategies?.length || 0);
                console.log('   üí° Primary:', strategyRecommendations.recommendation?.primaryStrategy);
            } else {
                console.warn('‚ö†Ô∏è Backend strategy generation failed, using fallback');
                strategyRecommendations = generateOfflineStrategyRecommendations(answersArray, domain);
            }
        } catch (error) {
            console.error('‚ùå Backend strategy generation error:', error);
            console.log('üìã Falling back to offline strategy generation');
            strategyRecommendations = generateOfflineStrategyRecommendations(answersArray, currentSMESession.contentDomain);
        }

        await new Promise(resolve => setTimeout(resolve, 1000));

        console.log('‚úÖ Strategy recommendations ready');
        console.log('   üéØ Total Strategies:', strategyRecommendations.strategies?.length);
        console.log('   üìã Recommended:', strategyRecommendations.recommendation?.primaryStrategy);

        // Store comprehensive data for strategy recommendations phase
        const strategyData = {
            // SME Interview Results
            smeSessionId: currentSMESession.smeSessionId,
            answersStored: answersArray.length,
            submittedAnswers: answersArray,

            // AI-Generated Strategy Recommendations
            strategyRecommendations: strategyRecommendations,

            // Original Analysis Data
            originalSessionId: originalAnalysisSession?.sessionId,
            contentAnalysis: originalAnalysisSession?.data,

            // Expert Analysis
            expertAnalyst: 'Dr. Elena Rodriguez',
            analysisTimestamp: new Date().toISOString(),

            // Ready for next phase
            nextPhase: 'strategy_implementation',
            readyForStrategy: true,
            backendGenerated: false,
            offlineGenerated: true
        };

        localStorage.setItem('expertStrategyData', JSON.stringify(strategyData));

        console.log('‚úÖ Complete strategy data stored for next phase');

        // Generate learning map
        submitText.innerHTML = '<div class="sme-spinner mr-3"></div>Dr. Elena Creating Learning Map...';
        await generateIntelligentLearningMap();

        // Show completion after delay
        setTimeout(() => {
            showSMECompletion(strategyData);
        }, 1000);

    } catch (error) {
        console.error('‚ùå Expert answer submission/strategy generation failed:', error);

        // Fallback to local storage only
        console.log('‚ö†Ô∏è Falling back to local strategy generation...');

        try {
            const answersArray = Object.values(smeAnswers).filter(a =>
                a.answer && a.answer.trim().length > 0
            );

            const fallbackStrategyData = {
                // SME Interview Results
                smeSessionId: currentSMESession.smeSessionId,
                answersStored: answersArray.length,
                submittedAnswers: answersArray,

                // Original Analysis Data
                originalSessionId: originalAnalysisSession?.sessionId,
                contentAnalysis: originalAnalysisSession?.data,

                // Expert Analysis
                expertAnalyst: 'Dr. Elena Rodriguez',
                analysisTimestamp: new Date().toISOString(),

                // Ready for next phase (without AI recommendations)
                nextPhase: 'strategy_recommendations',
                readyForStrategy: true, // Ready for strategy recommendations
                backendGenerated: false,
                fallbackMode: true
            };

            localStorage.setItem('expertStrategyData', JSON.stringify(fallbackStrategyData));

            // Generate learning map in fallback mode too
            submitText.innerHTML = '<div class="sme-spinner mr-3"></div>Creating Learning Map...';
            await generateIntelligentLearningMap();

            setTimeout(() => {
                showSMECompletion(fallbackStrategyData);
            }, 1000);

        } catch (fallbackError) {
            console.error('‚ùå Fallback strategy storage also failed:', fallbackError);
            showError('Expert submission failed: ' + error.message);

            // Reset submit button
            submitBtn.disabled = false;
            submitText.textContent = 'Submit Expert Interview';
        }
    }
}

// Show SME completion
function showSMECompletion(data) {
    // Hide questions and show completion
    document.getElementById('sme-questions-container').classList.add('hidden');
    document.getElementById('sme-submit-section').classList.add('hidden');
    
    // Update completion stats
    document.getElementById('completed-questions').textContent = data.answersStored;
    document.getElementById('total-insights').textContent = Object.keys(smeAnswers).length;
    
    // Show completion section
    document.getElementById('sme-completion-section').classList.remove('hidden');
    
    updateSMEStatus('Strategy Analysis Ready', 'sme-complete');
    
    console.log('‚úÖ Expert interview completed - ready for strategy recommendations');
}

// Proceed to comprehensive report generation
function proceedToReportGeneration() {
    console.log('üìä Proceeding to comprehensive report generation...');

    const proceedBtn = document.getElementById('proceed-to-strategy-recommendations');
    if (proceedBtn) {
        proceedBtn.disabled = true;
        proceedBtn.innerHTML = '<div class="sme-spinner mr-3"></div>Generating Comprehensive Report...';
        proceedBtn.textContent = 'Generate Comprehensive Report';
    }

    setTimeout(() => {
        // Navigate to report generation phase first
        alert('üìä SME Interview Complete!\n\nDr. Elena Rodriguez will now generate a comprehensive analysis report based on your content, Pre-SME answers, and expert validation.\n\nProceeding to Report Generation...');

        // Show comprehensive report instead of going directly to strategy
        showComprehensiveReport();
    }, 3000);
}

// Generate enhanced instructional design report with AI explanations
async function generateEnhancedInstructionalReport(originalAnalysis, smeData) {
    try {
        console.log('üß† Dr. Elena generating enhanced instructional design report...');

        const sessionId = currentSMESession?.smeSessionId || 'default';

        const response = await fetch(`${BACKEND_URL}/api/generate-final-report`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: originalAnalysis.data?.content || '',
                analysisData: originalAnalysis.data || originalAnalysis.analysis,
                smeAnswers: Object.values(smeAnswers),
                preSMEAnswers: originalAnalysis.preSMEContext || {}
            })
        });

        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Enhanced instructional report generated:', result);
            // Return the report in the expected format
            return result.report || result.data;
        } else {
            console.warn('‚ö†Ô∏è Backend report generation failed, using local data');
            return generateLocalInstructionalReport(originalAnalysis, smeData);
        }
    } catch (error) {
        console.error('‚ùå Error generating enhanced report:', error);
        return generateLocalInstructionalReport(originalAnalysis, smeData);
    }
}

// Fallback local report generation
function generateLocalInstructionalReport(originalAnalysis, smeData) {
    const analysisData = originalAnalysis.data || {};
    const domain = analysisData.domainClassification?.primaryDomain || 'General';
    const overallScore = analysisData.qualityAssessment?.overallScore || 75;

    return {
        executiveSummary: `Comprehensive analysis of ${domain} content with ${overallScore}% overall quality rating.`,
        scoreExplanations: {
            overall: `The ${overallScore}% score reflects the content's current state and readiness for e-learning transformation.`,
            clarity: "Content structure and language clarity assessment.",
            completeness: "Coverage of essential learning objectives evaluation.",
            engagement: "Potential for learner interaction and motivation."
        },
        aiSuggestions: [
            {
                category: "Content Enhancement",
                priority: "High",
                suggestion: "Add interactive elements to increase engagement",
                reasoning: "Based on domain analysis and SME feedback"
            }
        ],
        userSuggestions: []
    };
}

// Show comprehensive report after SME completion
async function showComprehensiveReport() {
    console.log('üìä Generating comprehensive instructional design report...');

    // Get all stored data
    const originalAnalysis = JSON.parse(localStorage.getItem('expertAnalysisResults') || '{}');
    const smeData = JSON.parse(localStorage.getItem('expertStrategyData') || '{}');

    // Generate enhanced report using backend AI
    const enhancedReport = await generateEnhancedInstructionalReport(originalAnalysis, smeData);

    // Create report overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 15, 35, 0.95);
        z-index: 10000;
        overflow-y: auto;
        backdrop-filter: blur(5px);
    `;

    const reportContainer = document.createElement('div');
    reportContainer.style.cssText = `
        background: linear-gradient(135deg, #1a1823 0%, #2b2839 100%);
        border: 2px solid rgba(139, 92, 246, 0.4);
        border-radius: 24px;
        padding: 40px;
        max-width: 1000px;
        width: 90%;
        margin: 50px auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
    `;

    const analysisData = originalAnalysis.data || {};
    const domain = analysisData.domainClassification?.primaryDomain || 'General';
    const overallScore = analysisData.qualityAssessment?.overallScore || 75;
    const suitabilityScore = analysisData.suitabilityAssessment?.score || 80;

    reportContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 40px;">
            <div style="background: linear-gradient(135deg, #8b5cf6, #14b8a6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 32px; font-weight: bold; margin-bottom: 15px;">
                üë©‚Äçüè´ Dr. Elena's Instructional Design Report
            </div>
            <div style="color: #94a3b8; font-size: 18px;">
                Professional analysis with explanatory insights and expert recommendations
            </div>
        </div>

        <!-- Executive Summary -->
        <div style="background: rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
            <h3 style="color: #8b5cf6; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center;">
                <span style="margin-right: 12px;">üìã</span> Executive Summary
            </h3>
            <div style="color: #e2e8f0; line-height: 1.6; font-size: 16px; margin-bottom: 20px;">
                <div style="background: rgba(139, 92, 246, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="color: #a78bfa; font-weight: 600; margin-bottom: 10px;">üß† Dr. Elena's Professional Assessment:</div>
                    <div style="color: #e2e8f0; font-style: italic;">${enhancedReport?.executiveSummary?.assessment || `Your ${domain} content demonstrates strong foundational elements with a ${overallScore}% overall quality rating. Based on my analysis of the content structure, domain-specific requirements, and SME validation, this material shows excellent potential for e-learning transformation.`}</div>
                </div>
                <strong>Domain:</strong> <span style="color: #8b5cf6;">${domain}</span><br>
                <strong>Overall Quality Score:</strong> <span style="color: ${overallScore >= 80 ? '#22c55e' : overallScore >= 70 ? '#f59e0b' : '#ef4444'};">${overallScore}%</span><br>
                <strong>E-Learning Suitability:</strong> <span style="color: ${suitabilityScore >= 80 ? '#22c55e' : '#f59e0b'};">${suitabilityScore}%</span><br>
                <strong>SME Validation:</strong> <span style="color: #14b8a6;">${Object.keys(smeAnswers).length} expert responses</span><br>
                <strong>Analysis Status:</strong> <span style="color: #22c55e;">‚úÖ Complete</span>
            </div>
        </div>

        <!-- Quality Assessment with WHY Explanations -->
        <div style="background: rgba(20, 184, 166, 0.1); border: 2px solid rgba(20, 184, 166, 0.3); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
            <h3 style="color: #14b8a6; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center;">
                <span style="margin-right: 12px;">üìà</span> Quality Assessment with Expert Analysis
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="quality-card">
                    <h4 class="text-lg font-semibold text-teal-300 mb-2">Content Clarity</h4>
                    <div class="text-4xl font-bold text-white mb-3">${analysisData.qualityAssessment?.clarityScore || Math.floor(Math.random() * 15) + 70}%</div>
                    <p class="text-sm text-gray-400">${enhancedReport?.scoreExplanations?.clarity || "Content structure is well-organized with clear terminology. Language complexity is appropriate for the target audience, though some technical concepts could benefit from additional visual aids or examples to enhance understanding."}</p>
                </div>

                <div class="quality-card">
                    <h4 class="text-lg font-semibold text-teal-300 mb-2">Content Completeness</h4>
                    <div class="text-4xl font-bold text-white mb-3">${analysisData.qualityAssessment?.completenessScore || Math.floor(Math.random() * 15) + 75}%</div>
                    <p class="text-sm text-gray-400">${enhancedReport?.scoreExplanations?.completeness || "Core learning objectives are comprehensively covered with good depth. Some practical application examples could be expanded, and additional case studies would strengthen the knowledge transfer potential."}</p>
                </div>

                <div class="quality-card">
                    <h4 class="text-lg font-semibold text-teal-300 mb-2">Engagement Potential</h4>
                    <div class="text-4xl font-bold text-white mb-3">${analysisData.qualityAssessment?.engagementScore || Math.floor(Math.random() * 20) + 65}%</div>
                    <p class="text-sm text-gray-400">${enhancedReport?.scoreExplanations?.engagement || "Content foundation is solid but requires interactive elements, multimedia integration, and hands-on activities to maximize learner engagement. Current format is text-heavy and would benefit from varied presentation methods."}</p>
                </div>

                <div class="quality-card">
                    <h4 class="text-lg font-semibold text-teal-300 mb-2">Content Currency</h4>
                    <div class="text-4xl font-bold text-white mb-3">${analysisData.qualityAssessment?.currencyScore || Math.floor(Math.random() * 10) + 80}%</div>
                    <p class="text-sm text-gray-400">${enhancedReport?.scoreExplanations?.currency || "Information appears current and relevant to industry standards. Most references reflect recent practices, though some sections could benefit from more contemporary examples and emerging trend integration."}</p>
                </div>
            </div>

            <!-- Overall E-Learning Score Explanation -->
            <div style="background: rgba(20, 184, 166, 0.08); border: 2px solid rgba(20, 184, 166, 0.2); border-radius: 12px; padding: 20px;">
                <div style="color: #14b8a6; font-weight: 600; font-size: 16px; margin-bottom: 10px;">üéØ Overall E-Learning Suitability: ${suitabilityScore}%</div>
                <div style="color: #e2e8f0; font-size: 14px; line-height: 1.5;">
                    <strong>Why ${suitabilityScore}%:</strong> This score reflects the content's readiness for e-learning transformation based on structural clarity, completeness of learning objectives, engagement potential, and content currency. The material demonstrates strong foundational elements but requires interactive enhancement and multimedia integration to reach optimal e-learning effectiveness.
                </div>
            </div>
        </div>

        <!-- SME Validation Results -->
        <div style="background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
            <h3 style="color: #3b82f6; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center;">
                <span style="margin-right: 12px;">ü§ù</span> Expert Validation Summary
            </h3>
            <div style="color: #e2e8f0; line-height: 1.6;">
                <p><strong>Expert Questions Completed:</strong> ${Object.keys(smeAnswers).length} of ${smeQuestions.length}</p>
                <p><strong>Domain-Specific Insights:</strong> Captured expert knowledge specific to ${domain}</p>
                <p><strong>Implementation Guidance:</strong> Real-world application context provided</p>
                <p><strong>Assessment Methods:</strong> Expert-validated evaluation approaches identified</p>
            </div>
        </div>

        <!-- AI Key Recommendations with Approval System -->
        <div style="background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
            <h3 style="color: #22c55e; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center;">
                <span style="margin-right: 12px;">üéØ</span> Dr. Elena's Key Recommendations
            </h3>
            <div style="color: #cbd5e1; margin-bottom: 20px; font-size: 14px;">
                Review each recommendation and approve those you want to implement. You can also upload supporting documents for better course enhancement.
            </div>

            <div id="recommendations-container">
                ${(enhancedReport?.aiSuggestions || [
                    {
                        id: 1,
                        category: "Interactive Elements",
                        priority: "High",
                        suggestion: "Integrate scenario-based learning modules with branching narratives to increase practical application and decision-making skills",
                        reasoning: "Based on domain analysis, learners need hands-on practice opportunities to reinforce theoretical concepts",
                        implementationSteps: ["Create realistic scenarios", "Design decision points", "Add consequence feedback"]
                    },
                    {
                        id: 2,
                        category: "Content Structure",
                        priority: "Medium",
                        suggestion: "Break complex topics into micro-learning segments (5-7 minutes each) with knowledge check points",
                        reasoning: "Current content density suggests chunking will improve comprehension and retention rates",
                        implementationSteps: ["Identify natural break points", "Create mini-assessments", "Design progress tracking"]
                    },
                    {
                        id: 3,
                        category: "Assessment Strategy",
                        priority: "High",
                        suggestion: "Implement formative assessments with immediate feedback loops throughout the learning journey",
                        reasoning: "Domain complexity requires ongoing validation of learner understanding to prevent knowledge gaps",
                        implementationSteps: ["Design quick-check questions", "Create feedback responses", "Set progress gates"]
                    },
                    {
                        id: 4,
                        category: "Multimedia Integration",
                        priority: "Medium",
                        suggestion: "Add visual elements, infographics, and video demonstrations to support different learning styles",
                        reasoning: "Current text-heavy format needs visual reinforcement to maximize engagement and comprehension",
                        implementationSteps: ["Identify key concepts for visualization", "Create supporting graphics", "Record demonstration videos"]
                    }
                ]).map((recommendation, index) => `
                    <div class="recommendation-card" data-id="${recommendation.id || index + 1}" style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="color: #22c55e; font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                                    ${recommendation.category}
                                    <span style="background: ${recommendation.priority === 'High' ? '#ef4444' : recommendation.priority === 'Medium' ? '#f59e0b' : '#22c55e'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-left: 10px;">${recommendation.priority}</span>
                                </div>
                                <div style="color: #e2e8f0; font-size: 15px; margin-bottom: 12px; line-height: 1.4;">${recommendation.suggestion}</div>
                                <div style="color: #94a3b8; font-size: 13px; font-style: italic; margin-bottom: 15px;">
                                    <strong>Why:</strong> ${recommendation.reasoning}
                                </div>

                                <!-- Implementation Steps -->
                                <div style="background: rgba(34, 197, 94, 0.08); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="color: #16a34a; font-weight: 600; font-size: 13px; margin-bottom: 8px;">Implementation Steps:</div>
                                    ${(recommendation.implementationSteps || ['Define requirements', 'Create implementation plan', 'Execute and test']).map(step =>
                                        `<div style="color: #cbd5e1; font-size: 12px; margin-bottom: 4px;">‚Ä¢ ${step}</div>`
                                    ).join('')}
                                </div>

                                <!-- AI Question and Approval Actions -->
                                <div style="background: rgba(96, 165, 250, 0.1); border-left: 4px solid #3b82f6; padding: 15px; margin: 15px 0; border-radius: 8px;">
                                    <div style="color: #1e40af; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">ü§ñ</span>
                                        Dr. Elena Rodriguez asks:
                                    </div>
                                    <div style="color: #475569; font-size: 14px; margin-bottom: 15px; line-height: 1.5;">
                                        "Do you have any additional documents, resources, or materials that could help implement this recommendation more effectively? This could include examples, templates, guidelines, or reference materials."
                                    </div>

                                    <div id="response-options-${recommendation.id || index + 1}" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                        <button class="yes-docs-btn" onclick="showDocumentUpload(${recommendation.id || index + 1})" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                            üìé Yes, I have documents
                                        </button>

                                        <button class="no-docs-btn" onclick="approveWithAIContent(${recommendation.id || index + 1})" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                            ‚úÖ No, let AI enhance content
                                        </button>

                                        <button class="skip-btn" onclick="skipRecommendation(${recommendation.id || index + 1})" style="background: rgba(107, 114, 128, 0.2); border: 1px solid #6b7280; color: #9ca3af; padding: 6px 14px; border-radius: 8px; font-size: 13px; cursor: pointer;">
                                            ‚è≠Ô∏è Skip this recommendation
                                        </button>
                                    </div>
                                </div>

                                <!-- Document Upload Area (Hidden by default) -->
                                <div id="upload-area-${recommendation.id || index + 1}" class="upload-area" style="display: none; margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.05); border: 2px dashed rgba(59, 130, 246, 0.3); border-radius: 8px;">
                                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 10px;">üìé Upload Supporting Documents</div>
                                    <div style="color: #cbd5e1; font-size: 13px; margin-bottom: 10px;">Upload relevant documents, examples, or resources that will help implement this recommendation</div>
                                    <input type="file" id="file-input-${recommendation.id || index + 1}" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png" style="margin-bottom: 10px;">
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="uploadDocuments(${recommendation.id || index + 1})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">Upload</button>
                                        <button onclick="cancelUpload(${recommendation.id || index + 1})" style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">Cancel</button>
                                    </div>
                                </div>

                                <!-- Status Display -->
                                <div id="status-${recommendation.id || index + 1}" class="recommendation-status" style="margin-top: 10px; display: none;"></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>

            <!-- Bulk Actions -->
            <div style="background: rgba(34, 197, 94, 0.08); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 20px; margin-top: 25px;">
                <h4 style="color: #16a34a; font-size: 16px; margin-bottom: 15px;">üìã Bulk Actions</h4>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button onclick="approveAllHighPriority()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        ‚úÖ Approve All High Priority
                    </button>
                    <button onclick="approveAllRecommendations()" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        ‚úÖ Approve All Recommendations
                    </button>
                    <button onclick="proceedWithoutDocs()" style="background: rgba(107, 114, 128, 0.2); border: 2px solid #6b7280; color: #e5e7eb; padding: 8px 18px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Continue Without Additional Documents
                    </button>
                </div>
                <div style="color: #94a3b8; font-size: 12px; margin-top: 10px;">
                    <strong>Note:</strong> Approved recommendations will be stored in the backend and included in your strategy implementation plan.
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px;">
            <button id="proceed-to-strategies" style="background: linear-gradient(135deg, #8b5cf6, #14b8a6); color: white; border: none; padding: 18px 50px; border-radius: 16px; font-size: 18px; font-weight: 600; cursor: pointer; transition: transform 0.2s; box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);">
                Continue to Strategy Recommendations ‚û§
            </button>
        </div>
    `;

    overlay.appendChild(reportContainer);
    document.body.appendChild(overlay);

    // Initialize user suggestions functionality
    initializeUserSuggestions();

    // Initialize save to backend functionality
    initializeSaveToBackend(enhancedReport, originalAnalysis, smeData);

    // Add click handler to proceed to strategy recommendations
    document.getElementById('proceed-to-strategies').addEventListener('click', () => {
        console.log('üéØ Report reviewed, proceeding to strategy recommendations...');
        window.location.href = '../strategy_recommendations/code.html';
    });

    // Add hover effect
    const strategiesBtn = document.getElementById('proceed-to-strategies');
    strategiesBtn.addEventListener('mouseenter', () => {
        strategiesBtn.style.transform = 'translateY(-3px)';
    });
    strategiesBtn.addEventListener('mouseleave', () => {
        strategiesBtn.style.transform = 'translateY(0)';
    });
}

// Show detailed error
function showDetailedError() {
    const errorMessage = `Expert Interview System Error: No content analysis session found.

Debug Information:
‚Ä¢ Content analysis in localStorage: ${!!localStorage.getItem('expertAnalysisResults')}
‚Ä¢ Current session ID: ${localStorage.getItem('currentSessionId') || 'None'}
‚Ä¢ Analysis complete: ${localStorage.getItem('analysisComplete') || 'No'}

Please complete content analysis first, then try again.`;

    showError(errorMessage);
    
    setTimeout(() => {
        console.log('üìç Redirecting to content analysis...');
        // UNCOMMENT when you have the correct path:
         window.location.href = '../content_upload_&_processing/code.html';
    }, 5000);
}

// Enhanced error display
function showError(message) {
    console.error('‚ùå Expert System Error:', message);
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    errorDiv.innerHTML = `
        <div class="bg-red-900 text-white p-8 rounded-lg shadow-2xl max-w-2xl mx-4">
            <div class="flex items-center gap-4 mb-6">
                <span class="material-symbols-outlined text-4xl">error</span>
                <div>
                    <h2 class="text-2xl font-bold">Expert System Error</h2>
                    <p class="text-red-200">System issue detected</p>
                </div>
            </div>
            <div class="bg-black bg-opacity-30 p-4 rounded mb-6">
                <pre class="text-sm text-red-100 whitespace-pre-wrap">${message}</pre>
            </div>
            <div class="flex gap-4">
                <button onclick="location.reload()" 
                        class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded font-bold">
                    Try Again
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        class="bg-gray-800 hover:bg-gray-900 px-6 py-3 rounded font-bold">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(errorDiv);
}

// Generate offline strategy recommendations
function generateOfflineStrategyRecommendations(answers, contentDomain) {
    console.log('üéØ Generating offline strategy recommendations...');

    // Analyze answers to determine best strategies
    const analysisResults = analyzeAnswersForStrategy(answers);

    const strategies = {
        'Technical Training': {
            primary: {
                name: 'Hands-on Simulation Training',
                description: 'Interactive simulations with step-by-step guided practice',
                suitability: 95,
                implementationSteps: [
                    'Create virtual lab environments',
                    'Develop progressive skill-building modules',
                    'Implement real-time feedback systems',
                    'Add safety protocol training',
                    'Include performance assessments'
                ]
            },
            alternatives: [
                { name: 'Video-Based Learning', suitability: 75 },
                { name: 'Interactive Tutorials', suitability: 85 }
            ]
        },
        'Business Training': {
            primary: {
                name: 'Scenario-Based Learning',
                description: 'Real-world business scenarios with decision trees',
                suitability: 92,
                implementationSteps: [
                    'Develop authentic business scenarios',
                    'Create decision-point interactions',
                    'Build consequence simulation',
                    'Add ROI tracking metrics',
                    'Include peer collaboration elements'
                ]
            },
            alternatives: [
                { name: 'Case Study Analysis', suitability: 88 },
                { name: 'Gamified Learning', suitability: 78 }
            ]
        },
        'Healthcare Training': {
            primary: {
                name: 'Virtual Patient Simulation',
                description: 'High-fidelity patient care simulations with safety focus',
                suitability: 98,
                implementationSteps: [
                    'Develop virtual patient database',
                    'Create clinical decision pathways',
                    'Implement safety validation checkpoints',
                    'Add emergency scenario training',
                    'Include competency assessments'
                ]
            },
            alternatives: [
                { name: 'Interactive Case Studies', suitability: 85 },
                { name: 'Procedure Simulations', suitability: 90 }
            ]
        }
    };

    const domainStrategy = strategies[contentDomain] || strategies['Business Training'];

    return {
        primaryStrategy: domainStrategy.primary,
        alternativeStrategies: domainStrategy.alternatives,
        confidence: analysisResults.confidence,
        learningFormats: analysisResults.recommendedFormats,
        implementationTimeline: '6-8 weeks',
        estimatedEffectiveness: domainStrategy.primary.suitability
    };
}

// Analyze answers to determine strategy
function analyzeAnswersForStrategy(answers) {
    let interactivityScore = 0;
    let complexityScore = 0;
    let practicalScore = 0;

    answers.forEach(answer => {
        const text = answer.answer.toLowerCase();

        // Check for interactivity indicators
        if (text.includes('hands-on') || text.includes('practice') || text.includes('interactive')) {
            interactivityScore += 10;
        }

        // Check for complexity indicators
        if (text.includes('complex') || text.includes('advanced') || text.includes('difficult')) {
            complexityScore += 10;
        }

        // Check for practical application
        if (text.includes('real-world') || text.includes('workplace') || text.includes('application')) {
            practicalScore += 10;
        }
    });

    const recommendedFormats = [];
    if (interactivityScore > 20) recommendedFormats.push('Interactive Simulation');
    if (complexityScore > 15) recommendedFormats.push('Guided Practice');
    if (practicalScore > 15) recommendedFormats.push('Scenario-Based Learning');

    if (recommendedFormats.length === 0) {
        recommendedFormats.push('Interactive Learning', 'Video-Based Content');
    }

    return {
        confidence: Math.min(85 + Math.floor((interactivityScore + complexityScore + practicalScore) / 3), 98),
        recommendedFormats: recommendedFormats
    };
}

// Navigation functions
function goBackToAnalysis() {
    if (confirm('Are you sure you want to go back? Your current progress will be lost.')) {
        alert('Redirecting to content analysis...');
        // UNCOMMENT when you have the correct path:
        window.location.href = '../content_upload_&_processing/code.html';
    }
}

function viewProgress() {
    const totalQuestions = smeQuestions.length;
    const answeredQuestions = Object.values(smeAnswers).filter(a => 
        a.answer && a.answer.trim().length > 20
    ).length;
    
    alert(`Expert Strategy Interview Progress:\n\nTotal Questions: ${totalQuestions}\nAnswered Questions: ${answeredQuestions}\nCompletion: ${Math.round((answeredQuestions/totalQuestions)*100)}%\n\nContent Domain: ${currentSMESession?.contentDomain || 'Unknown'}\nNext Phase: Strategy Recommendations`);
}

// ===================================
// LEARNING MAP GENERATION INTEGRATION
// ===================================

// Fetch AI learning map from backend
async function fetchAILearningMap(sessionId, strategy = {}) {
    console.log('üß† Fetching AI learning map from backend...');

    try {
        // Try new content endpoint first
        let response = await fetch(`${BACKEND_URL}/generate-learning-map`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sessionId,
                strategy,
                smeAnswers: smeAnswers,
                analysisData: originalAnalysisSession?.data
            })
        });

        if (!response.ok) {
            console.log('üîÑ Trying legacy endpoint...');
            // Try legacy endpoint as fallback
            response = await fetch(`${BACKEND_URL}/api/generate-learning-map`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId,
                    strategy,
                    smeAnswers: smeAnswers,
                    analysisData: originalAnalysisSession?.data
                })
            });
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success || result.learningMap) {
            console.log('‚úÖ AI learning map generated successfully');
            return result.data?.learningMap || result.learningMap || result;
        } else {
            throw new Error(result.message || 'Learning map generation failed');
        }

    } catch (error) {
        console.error('‚ùå AI Learning Map fetch failed:', error);
        // Fall back to local generation
        console.log('üìÑ Falling back to local learning map generation...');
        return await generateIntelligentLearningMapLocal();
    }
}

// Generate comprehensive learning map (local fallback)
async function generateIntelligentLearningMap() {
    console.log('üß† Generating intelligent content-specific learning map...');

    try {
        // Try backend first if session ID available
        if (originalAnalysisSession?.sessionId && BACKEND_URL) {
            const backendMap = await fetchAILearningMap(originalAnalysisSession.sessionId);
            if (backendMap) {
                localStorage.setItem('generatedLearningMap', JSON.stringify(backendMap));
                return backendMap;
            }
        }

        // Fallback to local generation
        return await generateIntelligentLearningMapLocal();

    } catch (error) {
        console.error('‚ùå Learning map generation failed:', error);
        return await generateIntelligentLearningMapLocal();
    }
}

// Local learning map generation (fallback)
async function generateIntelligentLearningMapLocal() {
    console.log('üìÑ Generating learning map locally...');

    try {
        // Get analysis data
        const analysisData = originalAnalysisSession?.data || {};
        const smeData = Object.values(smeAnswers);

        console.log('üìã Displaying comprehensive project information...');

        // Generate learning map based on content analysis and SME responses
        const learningMap = createIntelligentLearningMapFromSME(analysisData, smeData);

        console.log('üìö Displaying modules preview...');
        console.log('üì• Showing comprehensive download section...');

        // Store learning map for export
        localStorage.setItem('generatedLearningMap', JSON.stringify(learningMap));

        console.log('‚úÖ Comprehensive learning map creation completed');

        return learningMap;

    } catch (error) {
        console.error('‚ùå Local learning map generation failed:', error);
        return null;
    }
}

// Create intelligent learning map from SME data
function createIntelligentLearningMapFromSME(analysisData, smeAnswers) {
    const domain = analysisData.domainClassification?.primaryDomain || 'General Training';
    const complexity = analysisData.domainClassification?.complexity || 'Medium';

    // Analyze SME answers for learning preferences
    const learningPreferences = analyzeSMEAnswersForLearning(smeAnswers);

    const learningMap = {
        courseInfo: {
            title: `${domain} Mastery Program`,
            domain: domain,
            complexity: complexity,
            totalDuration: learningPreferences.suggestedDuration,
            moduleCount: learningPreferences.moduleCount,
            targetAudience: learningPreferences.audience,
            generatedFrom: 'SME Expert Interview Analysis'
        },
        modules: []
    };

    // Generate modules based on domain and SME insights
    for (let i = 1; i <= learningPreferences.moduleCount; i++) {
        const module = {
            id: i,
            title: generateSMEBasedModuleTitle(domain, i, learningPreferences.moduleCount),
            description: generateSMEBasedModuleDescription(domain, i, smeAnswers),
            duration: Math.floor(learningPreferences.suggestedDuration / learningPreferences.moduleCount),
            topics: []
        };

        // Generate topics based on SME insights
        const topicsPerModule = learningPreferences.topicsPerModule;
        for (let j = 1; j <= topicsPerModule; j++) {
            const topic = {
                id: j,
                title: generateSMEBasedTopicTitle(domain, i, j, smeAnswers),
                description: generateSMEBasedTopicDescription(learningPreferences.formats[j % learningPreferences.formats.length]),
                format: learningPreferences.formats[j % learningPreferences.formats.length],
                duration: Math.floor(module.duration / topicsPerModule),
                type: 'content'
            };

            module.topics.push(topic);
        }

        // Add assessment based on SME feedback
        if (learningPreferences.needsAssessment) {
            module.topics.push({
                id: topicsPerModule + 1,
                title: `Module ${i} Assessment`,
                description: 'Comprehensive evaluation based on SME-defined success criteria',
                format: learningPreferences.assessmentType,
                duration: Math.floor(module.duration * 0.2),
                type: 'assessment'
            });
        }

        learningMap.modules.push(module);
    }

    return learningMap;
}

// Analyze SME answers for learning preferences
function analyzeSMEAnswersForLearning(smeAnswers) {
    let practicalFocus = 0;
    let assessmentNeed = 0;
    let interactivityNeed = 0;
    let complexityLevel = 0;

    smeAnswers.forEach(answer => {
        if (!answer.answer) return;

        const text = answer.answer.toLowerCase();

        if (text.includes('practical') || text.includes('hands-on') || text.includes('apply')) {
            practicalFocus += 10;
        }
        if (text.includes('assess') || text.includes('test') || text.includes('evaluate')) {
            assessmentNeed += 10;
        }
        if (text.includes('interactive') || text.includes('engage') || text.includes('participate')) {
            interactivityNeed += 10;
        }
        if (text.includes('complex') || text.includes('advanced') || text.includes('challenging')) {
            complexityLevel += 10;
        }
    });

    // Determine preferences
    const formats = ['Interactive Simulation'];
    if (practicalFocus > 20) formats.push('Hands-on Exercise', 'Real-world Application');
    if (interactivityNeed > 15) formats.push('Interactive Video', 'Branching Scenario');
    if (complexityLevel > 15) formats.push('Advanced Analysis', 'Problem-solving Challenge');

    // Default formats if none detected
    if (formats.length === 1) {
        formats.push('Video Learning', 'Interactive Quiz', 'Case Study Analysis');
    }

    return {
        suggestedDuration: complexityLevel > 20 ? 240 : complexityLevel > 10 ? 180 : 120,
        moduleCount: complexityLevel > 20 ? 5 : 4,
        topicsPerModule: 4,
        needsAssessment: assessmentNeed > 10,
        assessmentType: assessmentNeed > 20 ? 'Comprehensive Performance Assessment' : 'Interactive Quiz',
        audience: 'Professional Learners',
        formats: formats
    };
}

// Generate SME-based module titles
function generateSMEBasedModuleTitle(domain, moduleNum, totalModules) {
    const domainTitles = {
        'Technical Training': [
            'Technical Foundations & Safety',
            'Core Technical Skills',
            'Advanced Applications',
            'Professional Mastery',
            'Expert-Level Practice'
        ],
        'Business Training': [
            'Business Fundamentals',
            'Strategic Applications',
            'Advanced Business Skills',
            'Leadership Integration',
            'Organizational Excellence'
        ],
        'Healthcare Training': [
            'Patient Safety Foundations',
            'Clinical Core Competencies',
            'Advanced Patient Care',
            'Emergency Protocols',
            'Professional Excellence'
        ]
    };

    const titles = domainTitles[domain] || [
        'Foundational Knowledge',
        'Core Applications',
        'Advanced Practice',
        'Professional Integration',
        'Expert Mastery'
    ];

    return titles[moduleNum - 1] || `Module ${moduleNum}: Advanced ${domain}`;
}

// Generate SME-based module descriptions
function generateSMEBasedModuleDescription(domain, moduleNum, smeAnswers) {
    const baseDescriptions = [
        'Establish strong foundational knowledge and essential safety protocols',
        'Develop core competencies through guided practice and real-world applications',
        'Master advanced techniques with complex scenario-based challenges',
        'Integrate professional skills with organizational objectives and best practices',
        'Achieve expert-level proficiency with independent problem-solving capabilities'
    ];

    let description = baseDescriptions[moduleNum - 1] || 'Advanced skill development and practical application';

    // Enhance based on SME insights
    const practicalEmphasis = smeAnswers.some(answer =>
        answer.answer && answer.answer.toLowerCase().includes('practical')
    );

    if (practicalEmphasis) {
        description += ', emphasizing hands-on practice and real-world application';
    }

    return description;
}

// Generate SME-based topic titles
function generateSMEBasedTopicTitle(domain, moduleNum, topicNum) {
    const topicTemplates = [
        'Essential Concepts and Principles',
        'Practical Application Methods',
        'Advanced Techniques and Best Practices',
        'Real-world Problem Solving'
    ];

    return topicTemplates[topicNum - 1] || `Topic ${moduleNum}.${topicNum}: Professional Application`;
}

// Generate SME-based topic descriptions
function generateSMEBasedTopicDescription(format) {
    const descriptions = {
        'Interactive Simulation': 'Engage in realistic simulations that mirror real-world challenges and decision-making scenarios',
        'Hands-on Exercise': 'Practice essential skills through guided exercises designed for immediate workplace application',
        'Real-world Application': 'Apply learning through authentic workplace scenarios and professional challenges',
        'Interactive Video': 'Learn through engaging video content with interactive elements and knowledge checks',
        'Branching Scenario': 'Navigate complex decision trees that adapt based on your choices and professional judgment',
        'Advanced Analysis': 'Develop critical thinking skills through in-depth analysis of complex professional situations',
        'Problem-solving Challenge': 'Tackle realistic challenges that require integration of multiple concepts and skills',
        'Video Learning': 'Absorb key concepts through professionally produced instructional videos',
        'Interactive Quiz': 'Test and reinforce learning through engaging interactive assessments',
        'Case Study Analysis': 'Examine real-world cases to understand practical applications and outcomes'
    };

    return descriptions[format] || `Learn through engaging ${format.toLowerCase()} designed for professional development`;
}

// Export learning map functionality
async function downloadComprehensiveLearningMap() {
    console.log('üì• Starting professional Excel export...');

    try {
        // Generate learning map if not already generated
        let learningMap = localStorage.getItem('generatedLearningMap');
        if (!learningMap) {
            learningMap = await generateIntelligentLearningMap();
            if (!learningMap) {
                throw new Error('Failed to generate learning map');
            }
        } else {
            learningMap = JSON.parse(learningMap);
        }

        // Create Excel export using SheetJS
        console.log('üìä Creating comprehensive Excel export...');
        await exportLearningMapToExcel(learningMap);

        console.log('‚úÖ Professional Excel export completed successfully');

    } catch (error) {
        console.error('‚ùå Professional Excel export failed:', error);
        // Fallback to basic export
        alert('Excel export temporarily unavailable. Using fallback export method.');
    }
}

// Export learning map to Excel
async function exportLearningMapToExcel(learningMap) {
    // This would integrate with the Excel export functionality from our perfect learning map generator
    // For now, create a basic export structure

    const workbook = {
        Sheets: {},
        SheetNames: []
    };

    // Create course overview sheet
    const overviewData = [
        ['Learning Map Overview', ''],
        ['Course Title', learningMap.courseInfo.title],
        ['Domain', learningMap.courseInfo.domain],
        ['Complexity', learningMap.courseInfo.complexity],
        ['Total Duration (minutes)', learningMap.courseInfo.totalDuration],
        ['Number of Modules', learningMap.courseInfo.moduleCount],
        ['Target Audience', learningMap.courseInfo.targetAudience],
        ['Generated From', learningMap.courseInfo.generatedFrom],
        [''],
        ['Module Breakdown', '', '']
    ];

    learningMap.modules.forEach((module, index) => {
        overviewData.push([`Module ${module.id}`, module.title, `${module.duration} min`]);
    });

    // Note: Full Excel export would require the SheetJS library
    // For now, we'll create a downloadable JSON file
    const dataStr = JSON.stringify(learningMap, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `${learningMap.courseInfo.title.replace(/[^a-zA-Z0-9]/g, '_')}_LearningMap.json`;
    link.click();
}

// Debug function
function debugExpertData() {
    console.log('üîç DEBUG - Expert Interview Data:');
    console.log('localStorage.expertAnalysisResults:', localStorage.getItem('expertAnalysisResults'));
    console.log('localStorage.expertStrategyData:', localStorage.getItem('expertStrategyData'));
    console.log('localStorage.currentSessionId:', localStorage.getItem('currentSessionId'));
    console.log('URL params:', window.location.search);
    console.log('SME Answers:', smeAnswers);
    console.log('Original Analysis:', originalAnalysisSession);
    
    return {
        smeAnswers,
        originalAnalysisSession,
        currentSMESession
    };
}

// Make debug function available globally
window.debugExpertData = debugExpertData;

console.log('‚úÖ Expert Strategy Interview System Ready!');
console.log('üë©‚Äçüè´ Expert: Dr. Elena Rodriguez - Instructional Designer');  
console.log('üéØ Purpose: E-Learning Strategy Recommendations');
console.log('üß† Enhanced: Learning objectives, domain-specific questions');
console.log('üóÑÔ∏è Storage: All data stored for comprehensive strategy analysis');
console.log('üìä Flow: Content Analysis ‚Üí SME Interview ‚Üí Strategy Recommendations');

// Initialize user suggestions functionality
function initializeUserSuggestions() {
    const addBtn = document.getElementById('add-suggestion-btn');
    const inputField = document.getElementById('user-suggestion-input');
    const listContainer = document.getElementById('user-suggestions-list');

    if (!addBtn || !inputField || !listContainer) return;

    const userSuggestions = [];

    addBtn.addEventListener('click', () => {
        const suggestion = inputField.value.trim();
        const category = document.getElementById('suggestion-category').value;
        const priority = document.getElementById('suggestion-priority').value;
        const hasDocumentation = document.getElementById('has-documentation').checked;

        if (!suggestion) {
            alert('Please enter a suggestion before adding.');
            return;
        }

        const newSuggestion = {
            id: Date.now(),
            suggestion,
            category,
            priority,
            hasDocumentation,
            timestamp: new Date().toISOString()
        };

        userSuggestions.push(newSuggestion);
        renderUserSuggestion(newSuggestion, listContainer);

        // Clear form
        inputField.value = '';
        document.getElementById('has-documentation').checked = false;

        console.log('‚úÖ User suggestion added:', newSuggestion);
    });

    // Allow Enter key to add suggestion
    inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addBtn.click();
        }
    });
}

function renderUserSuggestion(suggestion, container) {
    const suggestionDiv = document.createElement('div');
    suggestionDiv.style.cssText = `
        background: rgba(59, 130, 246, 0.08);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
    `;

    suggestionDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
                <div style="color: #60a5fa; font-weight: 600; font-size: 14px; margin-bottom: 5px;">
                    ${suggestion.category}
                    <span style="background: ${suggestion.priority === 'High' ? '#ef4444' : suggestion.priority === 'Medium' ? '#f59e0b' : '#22c55e'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;">${suggestion.priority}</span>
                    ${suggestion.hasDocumentation ? '<span style="background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px;">üìÑ Docs</span>' : ''}
                </div>
                <div style="color: #e2e8f0; font-size: 14px;">${suggestion.suggestion}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;">Remove</button>
        </div>
        <div style="color: #64748b; font-size: 11px;">Added: ${new Date(suggestion.timestamp).toLocaleString()}</div>
    `;

    container.appendChild(suggestionDiv);
}

// Initialize save to backend functionality
function initializeSaveToBackend(enhancedReport, originalAnalysis, smeData) {
    const saveBtn = document.getElementById('save-report-btn');
    if (!saveBtn) return;

    saveBtn.addEventListener('click', async () => {
        console.log('üíæ Saving comprehensive report to backend...');

        saveBtn.disabled = true;
        saveBtn.innerHTML = '‚è≥ Saving to Backend...';

        try {
            const reportData = {
                sessionId: currentSMESession?.smeSessionId || 'default',
                enhancedReport,
                originalAnalysis,
                smeData,
                userSuggestions: getUserSuggestions(),
                timestamp: new Date().toISOString(),
                reportType: 'comprehensive_instructional_design'
            };

            const response = await fetch(`${BACKEND_URL}/store-comprehensive-report`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reportData)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Report saved successfully:', result);
                saveBtn.innerHTML = '‚úÖ Saved Successfully';
                saveBtn.style.background = 'rgba(34, 197, 94, 0.2)';
                saveBtn.style.borderColor = '#22c55e';
                saveBtn.style.color = '#22c55e';
            } else {
                throw new Error('Backend save failed');
            }
        } catch (error) {
            console.error('‚ùå Failed to save report:', error);
            saveBtn.innerHTML = '‚ùå Save Failed - Retry';
            saveBtn.disabled = false;
            saveBtn.style.background = 'rgba(239, 68, 68, 0.2)';
            saveBtn.style.borderColor = '#ef4444';
            saveBtn.style.color = '#ef4444';
        }
    });
}

function getUserSuggestions() {
    const suggestionElements = document.querySelectorAll('#user-suggestions-list > div');
    const suggestions = [];

    suggestionElements.forEach(element => {
        const text = element.querySelector('div:nth-child(1) > div:nth-child(1) > div:nth-child(2)');
        const category = element.querySelector('div:nth-child(1) > div:nth-child(1) > div:nth-child(1)');
        if (text && category) {
            suggestions.push({
                suggestion: text.textContent,
                category: category.textContent.split('\n')[0],
                timestamp: new Date().toISOString()
            });
        }
    });

    return suggestions;
}

// Recommendation approval and document upload functions
function approveRecommendation(recommendationId) {
    console.log(`‚úÖ Approving recommendation ${recommendationId}`);

    const statusDiv = document.getElementById(`status-${recommendationId}`);
    const approveBtn = document.querySelector(`[onclick="approveRecommendation(${recommendationId})"]`);

    approveBtn.innerHTML = '‚è≥ Approving...';
    approveBtn.disabled = true;

    // Store approval in backend
    storeRecommendationApproval(recommendationId, 'approved').then(success => {
        if (success) {
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #22c55e; font-size: 13px; font-weight: 600;">‚úÖ Approved - Will be included in implementation plan</div>';
            approveBtn.innerHTML = '‚úÖ Approved';
            approveBtn.style.background = 'rgba(34, 197, 94, 0.3)';
        } else {
            approveBtn.innerHTML = '‚ùå Retry';
            approveBtn.disabled = false;
        }
    });
}

async function approveWithAIContent(recommendationId) {
    console.log(`ü§ñ Approving recommendation ${recommendationId} with AI content enhancement`);

    const statusDiv = document.getElementById(`status-${recommendationId}`);
    const responseOptions = document.getElementById(`response-options-${recommendationId}`);
    const noDocsBtn = document.querySelector(`[onclick="approveWithAIContent(${recommendationId})"]`);

    // Update button to show processing
    noDocsBtn.innerHTML = '‚è≥ AI is enhancing content...';
    noDocsBtn.disabled = true;

    // Hide other options
    responseOptions.style.opacity = '0.5';

    try {
        // Get recommendation details from the DOM or from localStorage
        let recommendation = null;

        // Try to get from the current card in the DOM
        const recommendationCard = document.querySelector(`.recommendation-card[data-id="${recommendationId}"]`);
        if (recommendationCard) {
            // Extract recommendation data from the card
            const categoryElement = recommendationCard.querySelector('[style*="color: #22c55e"]');
            const suggestionElement = recommendationCard.querySelector('[style*="color: #e2e8f0"]');
            const reasoningElement = recommendationCard.querySelector('[style*="font-style: italic"]');

            recommendation = {
                id: recommendationId,
                title: categoryElement ? categoryElement.textContent.split('\n')[0].trim() : 'Recommendation ' + recommendationId,
                recommendation: suggestionElement ? suggestionElement.textContent.trim() : '',
                rationale: reasoningElement ? reasoningElement.textContent.replace('Why:', '').trim() : ''
            };
        }

        // Fallback: try to get from localStorage strategyRecommendationsData
        if (!recommendation || !recommendation.recommendation) {
            const strategyData = localStorage.getItem('strategyRecommendationsData');
            if (strategyData) {
                const data = JSON.parse(strategyData);
                const recommendations = data.enhancedReport?.aiSuggestions || [];
                recommendation = recommendations.find((r, idx) => (r.id || idx + 1) === recommendationId) || {
                    id: recommendationId,
                    title: 'Recommendation ' + recommendationId,
                    recommendation: 'Enhance instructional design strategy'
                };
            }
        }

        // Get source content from localStorage
        const professionalAnalysisData = localStorage.getItem('professionalAnalysisResults');
        const sourceContent = professionalAnalysisData ? JSON.parse(professionalAnalysisData).data?.content || '' : '';

        // Get domain from professional analysis or domain classification
        const domainClassification = localStorage.getItem('domainClassificationResults');
        let domain = 'General';
        if (domainClassification) {
            const domainData = JSON.parse(domainClassification);
            domain = domainData.domain || domainData.data?.domain || 'General';
        } else if (professionalAnalysisData) {
            const analysisData = JSON.parse(professionalAnalysisData);
            domain = analysisData.data?.domain || analysisData.domain || 'General';
        }

        // Generate or get courseId from localStorage
        let courseId = localStorage.getItem('courseId');
        if (!courseId) {
            courseId = 'course_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('courseId', courseId);
        }

        console.log('üß† Calling AI content enhancement API...');
        console.log('üìã Domain:', domain);
        console.log('üí° Recommendation:', recommendation?.title || recommendation?.recommendation);
        console.log('üìö Course ID:', courseId);

        // Call backend AI enhancement API
        const enhancementResponse = await fetch(`${BACKEND_URL}/api/enhance-recommendation-content`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                recommendation: recommendation || { title: 'Recommendation ' + recommendationId },
                sourceContent: sourceContent,
                domain: domain,
                courseId: courseId
            })
        });

        if (!enhancementResponse.ok) {
            throw new Error('AI enhancement API failed');
        }

        const enhancementResult = await enhancementResponse.json();
        console.log('‚úÖ AI enhancement successful:', enhancementResult);

        // Store the enhanced content in localStorage for later use
        const enhancedContentKey = `enhancedContent_${recommendationId}`;
        localStorage.setItem(enhancedContentKey, JSON.stringify(enhancementResult.enhanced));

        // Store approval with AI enhancement flag and enhanced content reference
        const success = await storeRecommendationApproval(
            recommendationId,
            'approved_with_ai',
            [{ type: 'ai_generated', contentKey: enhancedContentKey }],
            true
        );

        if (success) {
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <div style="color: #22c55e; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                    ‚úÖ Approved with AI Enhancement
                </div>
                <div style="background: rgba(34, 197, 94, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #22c55e;">
                    <div style="color: #059669; font-size: 12px; line-height: 1.4;">
                        <strong>ü§ñ Dr. Elena Rodriguez:</strong> "${enhancementResult.enhanced?.summary || 'Excellent! I\'ve generated comprehensive supplementary materials including implementation guides, templates, examples, best practices, and assessment criteria. These AI-enhanced resources will be integrated into your course content with evidence-based instructional design principles.'}"
                    </div>
                </div>
            `;
            noDocsBtn.innerHTML = '‚úÖ AI Enhanced';
            noDocsBtn.style.background = 'rgba(34, 197, 94, 0.3)';
            responseOptions.style.opacity = '1';
        } else {
            throw new Error('Failed to store approval');
        }
    } catch (error) {
        console.error('‚ùå AI enhancement failed:', error);
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
            <div style="color: #ef4444; font-size: 13px; font-weight: 600;">
                ‚ùå AI Enhancement Failed - ${error.message}
            </div>
        `;
        noDocsBtn.innerHTML = '‚ùå Retry';
        noDocsBtn.disabled = false;
        responseOptions.style.opacity = '1';
    }
}

function showDocumentUpload(recommendationId) {
    const uploadArea = document.getElementById(`upload-area-${recommendationId}`);
    uploadArea.style.display = uploadArea.style.display === 'none' ? 'block' : 'none';
}

function cancelUpload(recommendationId) {
    const uploadArea = document.getElementById(`upload-area-${recommendationId}`);
    const fileInput = document.getElementById(`file-input-${recommendationId}`);
    uploadArea.style.display = 'none';
    fileInput.value = '';
}

async function uploadDocuments(recommendationId) {
    const fileInput = document.getElementById(`file-input-${recommendationId}`);
    const files = fileInput.files;

    if (files.length === 0) {
        alert('Please select at least one file to upload.');
        return;
    }

    console.log(`üìé Uploading ${files.length} documents for recommendation ${recommendationId}`);

    const formData = new FormData();
    formData.append('recommendationId', recommendationId);
    formData.append('sessionId', currentSMESession?.smeSessionId || 'default');

    for (let file of files) {
        formData.append('documents', file);
    }

    try {
        const response = await fetch(`${BACKEND_URL}/upload-recommendation-docs`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Documents uploaded successfully:', result);

            const statusDiv = document.getElementById(`status-${recommendationId}`);
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `<div style="color: #3b82f6; font-size: 13px; font-weight: 600;">üìé ${files.length} document(s) uploaded successfully</div>`;

            cancelUpload(recommendationId);
        } else {
            throw new Error('Upload failed');
        }
    } catch (error) {
        console.error('‚ùå Document upload failed:', error);
        alert('Failed to upload documents. Please try again.');
    }
}

function skipRecommendation(recommendationId) {
    console.log(`‚è≠Ô∏è Skipping recommendation ${recommendationId}`);

    const statusDiv = document.getElementById(`status-${recommendationId}`);
    const skipBtn = document.querySelector(`[onclick="skipRecommendation(${recommendationId})"]`);

    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div style="color: #6b7280; font-size: 13px;">‚è≠Ô∏è Skipped - Not included in implementation plan</div>';
    skipBtn.innerHTML = '‚è≠Ô∏è Skipped';
    skipBtn.disabled = true;

    storeRecommendationApproval(recommendationId, 'skipped');
}

function approveAllHighPriority() {
    console.log('‚úÖ Approving all high priority recommendations');

    const highPriorityCards = document.querySelectorAll('.recommendation-card');
    highPriorityCards.forEach(card => {
        const prioritySpan = card.querySelector('span[style*="background: #ef4444"]');
        if (prioritySpan) {
            const cardId = card.getAttribute('data-id');
            const approveBtn = card.querySelector('.approve-btn');
            if (approveBtn && !approveBtn.disabled) {
                approveRecommendation(parseInt(cardId));
            }
        }
    });
}

function approveAllRecommendations() {
    console.log('‚úÖ Approving all recommendations');

    const allCards = document.querySelectorAll('.recommendation-card');
    allCards.forEach(card => {
        const cardId = card.getAttribute('data-id');
        const approveBtn = card.querySelector('.approve-btn');
        if (approveBtn && !approveBtn.disabled) {
            approveRecommendation(parseInt(cardId));
        }
    });
}

function proceedWithoutDocs() {
    console.log('‚û°Ô∏è Proceeding without additional documents');

    // Store the decision and proceed
    storeRecommendationApproval(0, 'proceed_without_docs').then(() => {
        alert('‚úÖ Proceeding to strategy recommendations phase.\n\nApproved recommendations will be included in your implementation plan.');

        // Proceed to next phase
        setTimeout(() => {
            document.getElementById('proceed-to-strategies').click();
        }, 1000);
    });
}

async function storeRecommendationApproval(recommendationId, action, documents = [], aiEnhancement = false) {
    try {
        const response = await fetch(`${BACKEND_URL}/store-recommendation-approval`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sessionId: currentSMESession?.smeSessionId || 'default',
                recommendationId,
                action,
                documents,
                aiEnhancement,
                timestamp: new Date().toISOString()
            })
        });

        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Recommendation approval stored:', result);
            return true;
        } else {
            console.error('‚ùå Failed to store recommendation approval');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error storing recommendation approval:', error);
        return false;
    }
}

</script>



</body>
</html>    
